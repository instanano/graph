window.GraphPlotter=window.GraphPlotter||{state:{hot:null,colEnabled:{},activeGroup:null,activeText:null,activeDiv:null,activeFo:null,activeTicks:null,tickLabelStyles:{x:{},y:{},a:{},b:{},c:{}},lastXScale:null,lastYScale:null,multiYScales:null,axisScales:null,overrideX:null,overrideMultiY:{},overrideXTicks:null,overrideYTicks:{},overrideTernary:{},overrideTernaryTicks:{},overrideScaleformatX:null,overrideScaleformatY:{},overrideCustomTicksX:null,overrideCustomTicksY:{},overrideCustomTicksTernary:{},minorTickOn:{},useCustomTicksOn:{},shapeMode:"none",drawing:!1,drawStart:null,tempShape:null,arrowCount:0},config:{},utils:{},ChartRegistry:null,parsers:{},ui:{refs:{}},axis:{},features:{},init:null,renderChart:null},function(t){t.config.COLORS=["#FFFF00","#000000","#0000FF","#FF0000","#008000","#00FFFF","#FF00FF","#FFA500","#800080","#A52A2A"],t.config.DIM={W:600,H:300,MT:30,MB:60,ML:70,MR:80},t.config.SYMBOL_TYPES=[d3.symbolCircle,d3.symbolTriangle,d3.symbolSquare,d3.symbolDiamond,d3.symbolStar,d3.symbolCross],t.config.ratioPresets={"4:2.85":{linewidth:1.4,scalewidth:1.4,axisTitleFs:13,legendFs:13,scaleFs:12,xticks:6,yticks:5,multiygap:35},"16:9.15":{linewidth:1.2,scalewidth:1.2,axisTitleFs:11,legendFs:11,scaleFs:11,xticks:6,yticks:5,multiygap:35},"2:1.05":{linewidth:1.2,scalewidth:1.2,axisTitleFs:11,legendFs:11,scaleFs:11,xticks:6,yticks:5,multiygap:35},"3:1.2":{linewidth:1.2,scalewidth:1.2,axisTitleFs:11,legendFs:11,scaleFs:10,xticks:7,yticks:3,multiygap:35},"4:1.35":{linewidth:1.2,scalewidth:1.2,axisTitleFs:11,legendFs:11,scaleFs:10,xticks:7,yticks:2,multiygap:35}}}(window.GraphPlotter),function(t){t.utils.clearActive=function(){const e=t.state;e.activeGroup&&(e.activeGroup.select(".outline").attr("visibility","hidden"),e.activeGroup=null),e.activeText&&(e.activeText.attr("contenteditable",!1).style("border",null),e.activeText=null),e.activeDiv&&(e.activeDiv.attr("contenteditable",!1).style("border",null).style("cursor","move"),e.activeDiv=null),e.activeTicks&&(e.activeTicks.attr("contenteditable",!1).style("outline",null).style("cursor","pointer"),e.activeTicks=null,document.getElementById("axis-label").textContent="Axis Settings: Select Axis",document.getElementById("scalemin").value="",document.getElementById("scalemax").value="",document.getElementById("customticks").value=""),e.activeFo=null,t.ui.refs.boldBtn&&t.ui.refs.boldBtn.classed("active",!1),t.ui.refs.italicBtn&&t.ui.refs.italicBtn.classed("active",!1),t.ui.refs.rmBtn&&t.ui.refs.rmBtn.classed("disabled",!0),window.getSelection().removeAllRanges(),["scalemin","scalemax","tickcount","scaleformat","customticks","useCustomTicks","showMinorTicks"].forEach(t=>{document.getElementById(t).disabled=!0})},t.utils.rgbToHex=function(t){return"#"+t.match(/\d+/g).map(t=>(+t).toString(16).padStart(2,"0")).join("")},t.utils.applyDrag=d3.drag().on("start",function(e){t.state.hot.deselectCell(),e.sourceEvent.preventDefault(),t.utils.clearActive();const a=d3.select(this).raise();if(a.classed("shape-group"))t.features.activateShape(a);else{const e="foreignObject"===a.node().tagName?a:a.select("foreignObject"),r=e.select("div");t.features.activateText(r,e),setTimeout(()=>{window.getSelection().selectAllChildren(r.node())},0)}}).on("drag",function(t){const e=d3.select(this),a=e.attr("transform")||"",r=a.match(/translate\(([^,]+),([^)]+)\)/)||[],s=+r[1]||0,i=+r[2]||0,n=(/rotate\(([^)]+)\)/.exec(a)||[])[0]||"";e.attr("transform",`translate(${s+t.dx},${i+t.dy})${n}`)}).on("end",function(){const t=d3.select(this);if(t.classed("user-text")||t.classed("axis-title")||t.classed("legend-group")){const e=t.select("foreignObject div");t.classed("legend-group")&&(this.dataset.savedTransform=t.attr("transform")),e.on("blur",()=>{e.attr("contenteditable",!1).style("cursor","move")})}}),t.utils.updateInspector=function(e){const a=e.node(),r=window.getComputedStyle(a),s=parseFloat(e.attr("stroke-width"))||parseInt(r.fontSize,10),i="DIV"===a.tagName?r.color:"none"!==r.stroke?r.stroke:r.fill;t.ui.refs.sizeCtrl.property("value",s),t.ui.refs.colorCtrl.property("value",t.utils.rgbToHex(i));const n=r.fontFamily.split(",")[0].replace(/['"]/g,"");t.ui.refs.fontCtrl.property("value",n);const o="700"===r.fontWeight||"bold"===r.fontWeight;t.ui.refs.boldBtn.classed("active",o);const l="italic"===r.fontStyle;t.ui.refs.italicBtn.classed("active",l),t.ui.refs.rmBtn.classed("disabled",!1)},t.utils.editableText=function(t,{x:e,y:a,text:r,rotation:s}){const i=t.append("foreignObject").attr("x",e).attr("y",a).attr("transform",s?`rotate(${s},${e},${a})`:null).attr("overflow","visible"),n=i.append("xhtml:div").attr("contenteditable",!1).style("display","inline-block").style("white-space","nowrap").style("padding","2px").style("cursor","move").style("font-size","12px").html(r),o=n.node().scrollWidth,l=n.node().scrollHeight;return i.attr("width",o+2).attr("height",l+2),n.on("input",()=>{const t=n.node().scrollWidth,e=n.node().scrollHeight;i.attr("width",t+2).attr("height",e+2)}).on("keydown",t=>{"Enter"===t.key&&(t.preventDefault(),this.blur())}).on("blur",()=>{d3.select(n.node()).style("cursor","move")}),{fo:i,div:n,pad:2}}}(window.GraphPlotter),function(t){const e=new Map;t.ChartRegistry={register(t){if(!t.id||"function"!=typeof t.draw)throw new Error("Invalid chart registration");e.set(t.id,t)},get(t){const a=e.get(t);if(!a)throw new Error(`Unknown chart type: ${t}`);return a}}}(window.GraphPlotter),function(t){function e(){const e=t.state.hot.getData(),a=document.querySelector('label[for="icon1"]');if(!a)return;const r=e[0].some((a,r)=>t.state.colEnabled[r]&&e.slice(3).every(t=>null==t[r]||""===t[r]||isNaN(+t[r]))),s=a.querySelector(".warning-badge");if(r){if(!s){const t=document.createElement("span");t.className="warning-badge",t.textContent="!",a.appendChild(t)}}else s&&s.remove()}t.initTable=function(){const a=document.getElementById("table");t.state.hot=new myTable(a,{data:[["X-axis","Y-axis"],["#FFFF00","#000000"],["Sample","Sample"],[10,223],[20,132],[30,532],[40,242],[50,300],[70,100],[100,250]],colHeaders:e=>(t.state.colEnabled[e]=!1!==t.state.colEnabled[e],`<input type="checkbox" data-col="${e}" ${t.state.colEnabled[e]?"checked":""}>`),rowHeaders:t=>["Axis","Color","Name"][t]||t-2,rowHeaderWidth:60,colWidths:70,contextMenu:!0,afterRemoveRow:()=>{t.axis.resetScales(!0),t.renderChart()},afterRemoveCol:()=>{t.axis.resetScales(!0),t.renderChart()},afterCreateCol:(e,a)=>{for(let r=e;r<e+a;r++)t.state.hot.setDataAtCell(0,r,"Y-axis"),t.state.hot.setDataAtCell(1,r,t.config.COLORS[r%t.config.COLORS.length]),t.state.hot.setDataAtCell(2,r,"Sample")},cells:(e,a)=>{const r={};0===e&&(r.type="dropdown",r.source=["X-axis","Y-axis","Z-axis","Y-error"],r.className="tabledropdown"),1===e&&(r.renderer=(e,a,r,s,i,n)=>{if(a.innerHTML="",!["X-axis","Z-axis"].includes(e.getDataAtCell(0,s))){const i=document.createElement("input");i.type="color",i.value=n||t.config.COLORS[s%t.config.COLORS.length],i.oninput=t=>e.setDataAtCell(r,s,t.target.value),a.appendChild(i)}}),2===e&&(r.renderer=(t,e,a,r,s,i)=>{e.innerHTML=["X-axis","Z-axis"].includes(t.getDataAtCell(0,r))?"":i||"Sample"});const s=r.renderer||myTable.renderers.TextRenderer;return r.renderer=function(e,a,r,i,n,o){s.apply(this,arguments),a.style.background=t.state.colEnabled[i]?"":"lightcoral"},r}}),t.state.hot.addHook("afterCreateCol",e),a.addEventListener("change",a=>{if(a.target.matches('input[type="checkbox"][data-col]')){const r=+a.target.dataset.col;t.state.colEnabled[r]=a.target.checked,t.state.hot.render(),t.axis.resetScales(!1),t.renderChart(),e()}})}}(window.GraphPlotter),function(t){t.ChartRegistry.register({id:"line",dimensions:["x","y"],scaleBuilders:{x:d3.scaleLinear,y:d3.scaleLinear},draw:(t,e,a,r)=>{e.forEach((e,s)=>{const i=a.y2?a.y2[s]:a.y,n=d3.line().defined((t,a)=>Number.isFinite(e.x[a])&&Number.isFinite(e.y[a])).x((t,r)=>a.x(e.x[r])).y((t,a)=>i(e.y[a]));t.append("path").datum(e.y).attr("fill","none").attr("stroke",e.color).attr("stroke-width",r.linewidth).attr("d",n)})}}),t.ChartRegistry.register({id:"stacked",dimensions:["x","y"],scaleBuilders:{x:d3.scaleLinear,y:d3.scaleLinear},draw:(e,a,r,s)=>{const{H:i,MT:n,MB:o}=t.config.DIM,l=i-n-o,c=a.length+1,d=.1*l/c,u=(l-d*c)/a.length;a.forEach((t,a)=>{const i=d3.min(t.y),o=d3.max(t.y),l=n+d*(a+1)+u*a,c=l+u,h=d3.scaleLinear().domain([i,o]).range([c,l]),m=d3.line().defined((e,a)=>Number.isFinite(t.x[a])&&Number.isFinite(t.y[a])).x((e,a)=>r.x(t.x[a])).y((e,a)=>h(t.y[a]));e.append("path").datum(t.y).attr("fill","none").attr("stroke",t.color).attr("stroke-width",s.linewidth).attr("d",m)})}})}(window.GraphPlotter),function(t){t.ChartRegistry.register({id:"scatter",dimensions:["x","y"],scaleBuilders:{x:d3.scaleLinear,y:d3.scaleLinear},draw:(e,a,r,s)=>{t.ui.drawErrorBars(e,a,r,s),a.forEach((a,i)=>{const n=r.y2?r.y2[i]:r.y,o=d3.symbol().type(t.config.SYMBOL_TYPES[i%t.config.SYMBOL_TYPES.length]).size(Math.PI*Math.pow(s.symbolsize,2));e.selectAll().data(a.x).enter().append("path").attr("d",o).attr("transform",(t,e)=>`translate(${r.x(t)},${n(a.y[e])})`).attr("fill",a.color)})}}),t.ChartRegistry.register({id:"scatterline",dimensions:["x","y"],scaleBuilders:{x:d3.scaleLinear,y:d3.scaleLinear},draw:(e,a,r,s)=>{t.ChartRegistry.get("line").draw(e,a,r,s),t.ChartRegistry.get("scatter").draw(e,a,r,s)}})}(window.GraphPlotter),function(t){t.ChartRegistry.register({id:"bar",dimensions:["x","y"],scaleBuilders:{x:d3.scaleBand,y:d3.scaleLinear},bandPadding:.1,draw:(e,a,r,s)=>{const i=r.x.bandwidth()/a.length;a.forEach((t,a)=>{e.selectAll().data(t.y).enter().append("rect").attr("x",(e,s)=>r.x(t.rawX[s])+a*i).attr("y",t=>r.y(t)).attr("width",i).attr("height",t=>r.y.range()[0]-r.y(t)).attr("fill",t.color)}),t.ui.drawErrorBars(e,a,r,s)}}),t.ChartRegistry.register({id:"histogram",dimensions:["x","y"],scaleBuilders:{x:d3.scaleLinear,y:d3.scaleLinear},bandPadding:.1,draw:(e,a,r,s)=>{const i=r.x.domain(),[n,o]=i,l=(o-n)/s.bins,c=d3.range(n,o,l);let d=0;const u=a.map(t=>{const e=t.y.filter(t=>Number.isFinite(t)&&t>=n&&t<=o),a=d3.histogram().domain([n,o]).thresholds(c)(e);return d=Math.max(d,d3.max(a,t=>t.length)),a});a.forEach((i,n)=>{const o=u[n],l=d3.scaleBand().domain(o.map(t=>t.x0)).range([t.config.DIM.ML,t.config.DIM.W-t.config.DIM.MR]).padding(t.ChartRegistry.get(s.type).bandPadding),c=l.bandwidth();e.selectAll("rect.hist-bin-"+n).data(o).enter().append("rect").attr("class","hist-bin-"+n).attr("x",t=>l(t.x0)).attr("width",c).attr("y",t=>r.y(t.length)).attr("height",e=>t.config.DIM.H-t.config.DIM.MB-r.y(e.length)).attr("fill",i.color).attr("fill-opacity",.5+.5/a.length)})}})}(window.GraphPlotter),window.GraphPlotter.ChartRegistry.register({id:"area",dimensions:["x","y"],scaleBuilders:{x:d3.scaleLinear,y:d3.scaleLinear},draw:(t,e,a,r)=>{e.forEach((e,s)=>{const i=a.y2?a.y2[s]:a.y,n=d3.area().defined((t,a)=>Number.isFinite(e.x[a])&&Number.isFinite(e.y[a])).x((t,r)=>a.x(e.x[r])).y0(()=>i.range()[0]).y1((t,a)=>i(e.y[a]));t.append("path").datum(e.y).attr("fill",e.color).attr("fill-opacity",r.opacity).attr("stroke",e.color).attr("stroke-width",0).attr("d",n)})}}),function(t){function e(e,a,r,s={}){t.axis.drawTernaryAxis(e,r);const i=t.config.DIM,n=i.W-i.ML-i.MR,o=i.H-i.MT-i.MB,l=Math.min(n,2*o/Math.sqrt(3)),c=l*Math.sqrt(3)/2,d=i.ML+(n-l)/2,u=i.MT+(o-c)/2+c,h=d+l,m=u,p=d+l/2,f=u-c,y=t.state.overrideTernary?.a||[0,100],g=t.state.overrideTernary?.b||[0,100],x=t.state.overrideTernary?.c||[0,100],v=(t,e)=>(t-e[0])/(e[1]-e[0]);a.forEach((a,i)=>{const n=a.rawX.map((t,e)=>{const r=v(t,y),s=v(a.y[e],g),i=v(a.z[e],x),n=r+s+i;if(!n)return null;return{x:(r*h+s*p+i*d)/n,y:(r*m+s*f+i*u)/n,i:e}}).filter(Boolean);if(s.area&&e.append("polygon").attr("points",n.map(t=>`${t.x},${t.y}`).join(" ")).attr("fill",a.color).attr("fill-opacity",r.opacity||1),s.line){const t=d3.line().x(t=>t.x).y(t=>t.y);e.append("path").datum(n).attr("fill","none").attr("stroke",a.color).attr("stroke-width",r.linewidth).attr("d",t)}if(s.symbol){const s=d3.symbol().type(t.config.SYMBOL_TYPES[i%t.config.SYMBOL_TYPES.length]).size(Math.PI*r.symbolsize**2);n.forEach(t=>e.append("path").attr("d",s).attr("transform",`translate(${t.x},${t.y})`).attr("fill",a.color))}})}t.ChartRegistry.register({id:"ternary",dimensions:["x","y","z"],draw:(a,r,s,i)=>{t.axis.drawTernaryGridLines(a,i),e(a,r,i,{symbol:!0})}}),t.ChartRegistry.register({id:"ternaryline",dimensions:["x","y","z"],draw:(a,r,s,i)=>{t.axis.drawTernaryGridLines(a,i),e(a,r,i,{symbol:!0,line:!0})}}),t.ChartRegistry.register({id:"ternaryarea",dimensions:["x","y","z"],draw:(a,r,s,i)=>{t.axis.drawTernaryGridLines(a,i),e(a,r,i,{area:!0})}})}(window.GraphPlotter),function(t){t.axis.prepareChartContext=function(){const e=t.getSettings(),a=t.getSeries(),[r,s]=e.ratio.split(":").map(Number);t.config.DIM.H=Math.round(t.config.DIM.W*s/r),t.config.DIM.MR=80+(1===e.multiyaxis&&a.length>1?(a.length-2)*e.multiygap:0);const i=t.axis.getTitles(e.mode),{xScale:n,yScale:o}=t.axis.makeScales(e,a);return t.state.lastXScale=n,t.state.lastYScale=o,{s:e,series:a,xScale:n,yScale:o,W:t.config.DIM.W,H:t.config.DIM.H,MT:t.config.DIM.MT,MB:t.config.DIM.MB,ML:t.config.DIM.ML,MR:t.config.DIM.MR,titles:i}},t.axis.makeScales=function(e,a){const r=t.config.DIM;if("histogram"===e.type){const s=a.flatMap(t=>t.y).filter(t=>Number.isFinite(t)),[i,n]=d3.extent(s),o=(n-i)/e.bins,l=d3.range(i,n,o),c=d3.max(a.map(t=>d3.max(d3.histogram().domain([i,n]).thresholds(l)(t.y),t=>t.length))),d=t.state.overrideX||[i,n],u=t.state.overrideMultiY?.[0]||[0,1.05*c];return{xScale:d3.scaleLinear().domain(d).range([r.ML,r.W-r.MR]),yScale:d3.scaleLinear().domain(u).range([r.H-r.MB,r.MT])}}if("bar"===e.type){const e=a.flatMap(t=>t.rawX),s=a.flatMap(t=>t.y).filter(t=>Number.isFinite(t)),[i,n]=d3.extent(s),o=.06*(n-i),l=t.state.overrideMultiY?.[0]||[i-o,n+o];return{xScale:d3.scaleBand().domain(e).range([r.ML,r.W-r.MR]).padding(t.ChartRegistry.get("bar").bandPadding),yScale:d3.scaleLinear().domain(l).range([r.H-r.MB,r.MT])}}const s=a.flatMap(t=>t.x).filter(t=>Number.isFinite(t)),i=a.flatMap(t=>t.y).filter(t=>Number.isFinite(t)),[n,o]=d3.extent(s),[l,c]=d3.extent(i),d=.02*(o-n),u=.06*(c-l);let h;h=t.state.overrideX?t.state.overrideX:"ftir"===e.mode||"nmr"===e.mode?[o+d,n-d]:[n-d,o+d];const m=t.state.overrideMultiY?.[0]?t.state.overrideMultiY[0]:[l-u,c+u];return{xScale:d3.scaleLinear().domain(h).range([r.ML,r.W-r.MR]),yScale:d3.scaleLinear().domain(m).range([r.H-r.MB,r.MT])}},t.axis.resetScales=function(e=!0){const a=t.state;e&&(a.overrideX=null,a.overrideMultiY={},a.overrideXTicks=null,a.overrideYTicks={},a.overrideScaleformatX=null,a.overrideScaleformatY={},a.overrideCustomTicksX=null,a.overrideCustomTicksY={},a.overrideCustomTicksTernary=null,a.overrideTernary=null,a.overrideTernaryTicks=null,a.minorTickOn={},a.useCustomTicksOn={});const r=function(t){if(!t.length)return null;const e=t.flatMap(t=>t.x),a=t.flatMap(t=>t.y),[r,s]=d3.extent(e),[i,n]=d3.extent(a),o=.02*(s-r),l=.06*(n-i);return{minX:r-o,maxX:s+o,minY:i-l,maxY:n+l}}(t.getSeries());r&&e&&(document.getElementById("scalemin").value=r.minX,document.getElementById("scalemax").value=r.maxX)}}(window.GraphPlotter),function(t){function e(e,a=0){const r=d3.format(""),s=d3.format(".2s"),i=d3.format(".0e"),n=t.state;let o=0;return"x"===e?o=n.overrideScaleformatX??0:"y"===e?o=n.overrideScaleformatY?.[a]??0:"a"!==e&&"b"!==e&&"c"!==e||(o=n.overrideScaleformatTernary?.[e]??0),1===o?s:2===o?i:r}t.axis.getTitles=function(t){switch(t){case"uvvis":return{x:"Wavelength (nm)",y:"Absorbance (a.u.)"};case"tauc":return{x:"Energy (eV)",y:"Intensity (a.u.)"};case"xrd":return{x:"2θ (°)",y:"Intensity (a.u.)"};case"ftir":return{x:"Wavenumber (cm<sup>-1</sup>)",y:"Transmittance (%)"};case"raman":return{x:"Raman Shift (cm<sup>-1</sup>)",y:"Intensity (a.u.)"};case"pl":return{x:"Wavelength (nm)",y:"Intensity (a.u.)"};case"xps":return{x:"Binding Energy (eV)",y:"Intensity (cps)"};case"tga":return{x:"Temperature (°C)",y:"Weight (%)"};case"dsc":return{x:"Temperature (°C)",y:"Heat Flow (mW)"};case"bet":return{x:"Relative Pressure (P/P<sub>0</sub>)",y:"Adsorbed Volume (cm<sup>3</sup>·g<sup>-1</sup>)"};case"saxs":return{x:"Scattering Vector q (Å<sup>-1</sup>)",y:"Intensity (a.u.)"};case"nmr":return{x:"δ (ppm)",y:"Intensity (a.u.)"};case"ternary":return{a:"A-axis",b:"B-axis",c:"C-axis"};case"tensile":return{x:"Strain",y:"Stress"};default:return{x:"x-axis",y:"y-axis"}}},t.axis.applyTickStyles=function(e,a,r,s,i="currentColor"){const n=(t.state.tickLabelStyles[a]||{})[r]||{};e.selectAll("text").classed("tick-label",!0).classed(`tick-${a}`,!0).style("font-size",n.fontSize||s+"px").style("fill",n.color||i).style("font-family",n.fontFamily||"Arial").style("font-weight",n.fontWeight||"normal").style("font-style",n.fontStyle||"normal").style("cursor","default")},t.axis.addMinorTicks=function(e,a,r,s=0,i=4,n=1,o="currentColor"){if("function"!=typeof a.ticks)return;let l=null,c=null;if(null!=e.attr("data-xi"))l=t.state.overrideCustomTicksX||null,sel="X"===window.selectedAxisName,c="X";else if(null!=e.attr("data-yi")){const a=+e.attr("data-yi");l=t.state.overrideCustomTicksY&&t.state.overrideCustomTicksY[a]||null,sel=window.selectedAxisName===(0===a?"Y":"Y"+(a+1)),c="Y"+a}else null!=e.attr("data-ai")?(l=t.state.overrideCustomTicksTernary?.a||null,sel="A"===window.selectedAxisName,c="A"):null!=e.attr("data-bi")?(l=t.state.overrideCustomTicksTernary?.b||null,sel="B"===window.selectedAxisName,c="B"):null!=e.attr("data-ci")&&(l=t.state.overrideCustomTicksTernary?.c||null,sel="C"===window.selectedAxisName,c="C");if(!1===t.state.minorTickOn[c])return;const d=!0===t.state.useCustomTicksOn?.[c],u=a.domain();let h=[];if(d){if(!Array.isArray(l)||l.length<2)return;const t=l.filter(Number.isFinite).sort((t,e)=>t-e);for(let e=0;e<t.length-1;e++){const a=(t[e]+t[e+1])/2;a>=u[0]&&a<=u[1]&&h.push(a)}}else{if(r===d3.axisBottom?s=t.state.overrideXTicks??t.state.overrideTernaryTicks?.a??s:r===d3.axisLeft?s=t.state.overrideYTicks?.[0]??t.state.overrideTernaryTicks?.b??s:r===d3.axisRight&&(s=t.state.overrideTernaryTicks?.c??s),null==s)return;const e=a.ticks(s);if(e.length>=2){const t=e[1]-e[0];h=e.slice(0,-1).map(e=>e+t/2),e[0]-t/2>=u[0]&&h.unshift(e[0]-t/2),e[e.length-1]+t/2<=u[1]&&h.push(e[e.length-1]+t/2)}}if(!h.length)return;h=h.filter(t=>t>=Math.min(u[0],u[1])&&t<=Math.max(u[0],u[1]));const m=e.append("g").call(r(a).tickValues(h).tickSize(i).tickFormat(""));m.select("path.domain").remove(),m.selectAll("line").classed("minor-tick",!0).attr("stroke-width",n).attr("stroke",o)},t.axis.drawAxis=function(a,r,s,i,n){const o=t.config.DIM;if(["ternary","ternaryline","ternaryarea"].includes(i.type))return a.selectAll(".axis-title").remove(),void t.axis.renderTernaryAxes(a,i,o);a.selectAll(".axis-title.ternary").remove();const l=r.x,c=r.y,d=t.state.overrideCustomTicksX,u=d?null:t.state.overrideXTicks??i.xticks,h=t.state.overrideCustomTicksY&&t.state.overrideCustomTicksY[0],m=h?null:t.state.overrideYTicks&&null!=t.state.overrideYTicks[0]?t.state.overrideYTicks[0]:i.yticks,p=a.append("g").attr("data-xi",0).attr("transform","translate(0,"+(o.H-o.MB)+")").attr("stroke-width",i.scalewidth).call(d3.axisBottom(l).tickValues(d).ticks(u).tickSize(6).tickPadding(4).tickFormat("bar"===i.type?null:e("x",0)));t.axis.applyTickStyles(p,"x",0,i.scaleFs);const f=a.append("g").attr("data-yi",0).attr("transform","translate("+o.ML+",0)").attr("stroke-width",i.scalewidth).call(d3.axisLeft(c).tickValues(h).ticks(m).tickSize(6).tickPadding(4).tickFormat(e("y",0)));t.axis.applyTickStyles(f,"y",0,i.scaleFs),t.axis.addMinorTicks(p,l,d3.axisBottom,i.xticks,4,i.scalewidth,"currentColor"),t.axis.addMinorTicks(f,c,d3.axisLeft,i.yticks,4,i.scalewidth,"currentColor"),a.append("line").attr("x1",o.ML).attr("y1",o.MT).attr("x2",o.W-o.MR).attr("y2",o.MT).attr("stroke","black").attr("stroke-linecap","square").attr("stroke-width",i.scalewidth),a.append("line").attr("x1",o.W-o.MR).attr("y1",o.MT).attr("x2",o.W-o.MR).attr("y2",o.H-o.MB).attr("stroke","black").attr("stroke-linecap","square").attr("stroke-width",i.scalewidth),function(a,r,s,i){const n=r.y,o=t.config.DIM;if(1===s.multiyaxis&&["line","area","scatter","scatterline"].includes(s.type)&&i.length>1){if(r.y2=i.map((t,e)=>{if(0===e)return n;const[a,r]=d3.extent(t.y);return d3.scaleLinear().domain([a-.06*(r-a),r+.06*(r-a)]).range([o.H-o.MB,o.MT])}),t.state.multiYScales=r.y2,t.state.overrideMultiY)for(const[e,a]of Object.entries(t.state.overrideMultiY)){const r=+e;t.state.multiYScales[r]&&t.state.multiYScales[r].domain(a)}i.slice(1).forEach((r,i)=>{const n=i+1,l=t.state.overrideCustomTicksY&&t.state.overrideCustomTicksY[n],c=l?null:t.state.overrideYTicks&&null!=t.state.overrideYTicks[n]?t.state.overrideYTicks[n]:s.yticks,d=a.append("g").attr("data-yi",n).attr("transform",`translate(${o.W-o.MR+i*s.multiygap},0)`).attr("stroke-width",s.scalewidth).call(d3.axisRight(t.state.multiYScales[n]).tickValues(l).ticks(c).tickFormat(e("y",n)));d.selectAll("path,line").attr("stroke",r.color),t.axis.addMinorTicks(d,t.state.multiYScales[n],d3.axisRight,c,4,s.scalewidth,r.color),t.axis.applyTickStyles(d,"y",n,s.scaleFs,r.color)})}}(a,r,i,n),function(e,a,r){a.forEach(a=>{let s=e.select(`g.axis-title-${a.key}`);if(s.empty()){s=e.append("g").classed(`axis-title axis-title-${a.key} user-text`,!0).attr("data-axis-mode",r).attr("transform",`translate(${a.pos[0]},${a.pos[1]}) ${a.rotation?`rotate(${a.rotation})`:""}`.replace(/\s+/g," ")).call(t.utils.applyDrag);const i=t.utils.editableText(s,{x:0,y:0,text:a.label,rotation:0});i.div.html(a.label),i.fo.attr("width",i.div.node().scrollWidth+5).attr("x",-(i.div.node().scrollWidth+5)/2).attr("y",0),i.div.style("text-align",a.anchor||"middle")}else if(s.attr("data-axis-mode")!==r){const t=s.select("foreignObject");t.select("div").html(a.label);const e=t.select("div").node().scrollWidth+5;t.attr("width",e).attr("x",-e/2).attr("y",0),s.attr("data-axis-mode",r)}s.attr("transform",`translate(${a.pos[0]},${a.pos[1]}) ${a.rotation?`rotate(${a.rotation})`:""}`.replace(/\s+/g," "))})}(a,[{key:"x",label:s.x,pos:[o.W/2,o.H-o.MB/1.7],rotation:0,anchor:"middle"},{key:"y",label:s.y,pos:[o.ML-60,o.H/2],rotation:-90,anchor:"middle"}],i.mode)},t.axis.renderTernaryAxes=function(e,a,r){t.axis.drawTernaryAxis(e,a);const s=r.W-r.ML-r.MR,i=r.H-r.MT-r.MB,n=Math.min(s,2*i/Math.sqrt(3)),o=n*Math.sqrt(3)/2,l=[r.ML+(s-n)/2,r.MT+(i-o)/2+o],c=[l[0]+n,l[1]],d=[l[0]+n/2,l[1]-o];[{text:"A-axis",x:(c[0]+d[0])/2+50,y:(c[1]+d[1])/2-25,rot:60,cls:"tern-x"},{text:"B-axis",x:(l[0]+d[0])/2-50,y:(l[1]+d[1])/2-25,rot:-60,cls:"tern-y"},{text:"C-axis",x:(l[0]+c[0])/2,y:l[1]+25,rot:0,cls:"tern-z"}].forEach(({text:a,x:r,y:s,rot:i,cls:n})=>{const o=e.append("g").classed(`axis-title ternary ${n} user-text`,!0).attr("transform",`translate(${r},${s}) rotate(${i})`),{fo:l,div:c}=t.utils.editableText(o,{x:0,y:0,text:a,rotation:0});l.attr("width",c.node().scrollWidth+5).attr("x",-(c.node().scrollWidth+5)/2)})},t.axis.drawTernaryAxis=function(e,a){const r=t.config.DIM,s=r.W-r.ML-r.MR,i=r.H-r.MT-r.MB,n=Math.min(s,2*i/Math.sqrt(3)),o=n*Math.sqrt(3)/2,l=r.ML+(s-n)/2,c=r.MT+(i-o)/2+o,d=l+n,u=t.state.overrideTernary?.a||[0,100],h=t.state.overrideTernary?.b||[0,100],m=t.state.overrideTernary?.c||[0,100],p=d3.scaleLinear().domain(u).range([0,n]),f=d3.scaleLinear().domain(h).range([n,0]),y=d3.scaleLinear().domain(m).range([0,n]),g=t.state.overrideCustomTicksTernary?.a,x=t.state.overrideCustomTicksTernary?.b,v=t.state.overrideCustomTicksTernary?.c,w=g?null:t.state.overrideTernaryTicks?.a??a.xticks,k=x?null:t.state.overrideTernaryTicks?.b??a.xticks,b=v?null:t.state.overrideTernaryTicks?.c??a.xticks;t.state.axisScales={a:p,b:f,c:y};const T=e.append("g").attr("data-ai",0).attr("transform",`translate(${l},${c})`).attr("stroke-width",a.scalewidth).call(d3.axisBottom(p).tickValues(g).ticks(w).tickSize(6).tickPadding(4));t.axis.applyTickStyles(T,"a",0,a.scaleFs);const S=e.append("g").attr("data-bi",0).attr("transform",`translate(${l},${c}) rotate(210)`).attr("stroke-width",a.scalewidth).call(d3.axisLeft(f).tickValues(x).ticks(k).tickSize(-6).tickPadding(15));S.selectAll("text").attr("transform","rotate(-210)").style("text-anchor","middle").attr("dy","0px"),t.axis.applyTickStyles(S,"b",0,a.scaleFs);const M=e.append("g").attr("data-ci",0).attr("transform",`translate(${d},${c}) rotate(150)`).attr("stroke-width",a.scalewidth).call(d3.axisRight(y).tickValues(v).ticks(b).tickSize(-6).tickPadding(15));M.selectAll("text").attr("transform","rotate(-150)").style("text-anchor","middle").attr("dy","0px"),t.axis.applyTickStyles(M,"c",0,a.scaleFs),t.axis.addMinorTicks(T,p,d3.axisBottom,w,4,a.scalewidth,"currentColor"),t.axis.addMinorTicks(S,f,d3.axisLeft,k,-4,a.scalewidth,"currentColor"),t.axis.addMinorTicks(M,y,d3.axisRight,b,-4,a.scalewidth,"currentColor")},t.axis.drawTernaryGridLines=function(e,a){const r=t.config.DIM,s=r.W-r.ML-r.MR,i=r.H-r.MT-r.MB,n=Math.min(s,2*i/Math.sqrt(3)),o=n*Math.sqrt(3)/2,l=r.ML+(s-n)/2,c=r.MT+(i-o)/2+o,d=l+n,u=c,h=l+n/2,m=c-o,p=t.state.overrideTernary||{},f=[p.a||[0,100],p.b||[0,100],p.c||[0,100]],y=[[l,c,d,u,h,m],[d,u,l,c,h,m],[h,m,l,c,d,u]];[d3.scaleLinear().domain(f[0]).range([0,n]),d3.scaleLinear().domain(f[1]).range([n,0]),d3.scaleLinear().domain(f[2]).range([0,n])].forEach((t,r)=>t.ticks(a.xticks).forEach(t=>{if(t<=f[r][0]||t>=f[r][1])return;const s=(t-f[r][0])/(f[r][1]-f[r][0]),[i,n,o,l,c,d]=y[r];e.append("line").attr("x1",i+(o-i)*s).attr("y1",n+(l-n)*s).attr("x2",i+(c-i)*s).attr("y2",n+(d-n)*s).attr("stroke",a.gridcolor||"#ccc").attr("stroke-width",a.gridwidth||1).attr("stroke-dasharray","2,2")}))}}(window.GraphPlotter),function(t){function e(e,a){document.getElementById(e).addEventListener("input",r=>{const s=parseFloat(r.target.value),i=parseFloat(document.getElementById("scalemin"===e?"scalemax":"scalemin").value);if(!isNaN(s)&&!isNaN(i)){if("X"===window.selectedAxisName)t.state.overrideX=a?[s,i]:[i,s];else if(window.selectedAxisName.startsWith("Y")){const e=window.activeYi||0;t.state.overrideMultiY=t.state.overrideMultiY||{},t.state.overrideMultiY[e]=a?[s,i]:[i,s]}else if(["A","B","C"].includes(window.selectedAxisName)){const e=window.selectedAxisName.toLowerCase();t.state.overrideTernary=t.state.overrideTernary||{},t.state.overrideTernary[e]=a?[s,i]:[i,s]}t.renderChart()}})}t.axis.tickEditing=function(e){e.selectAll("g.tick,path.domain,text.tick-label,line.minor-tick,g.tick line").style("cursor","pointer").on("click",e=>{e.stopPropagation(),t.utils.clearActive(),"bar"===document.querySelector('input[name="charttype"]:checked').id&&d3.select(e.currentTarget).classed("tick-x")||["scalemin","scalemax","tickcount","scaleformat","customticks","useCustomTicks","showMinorTicks"].forEach(t=>document.getElementById(t).disabled=!1);const a=e.currentTarget,r="path"===a.tagName?a.parentNode:"g"===a.tagName?a:a.closest("g[data-xi],g[data-yi],g[data-ai],g[data-bi],g[data-ci]");if(!r)return;const s=r.getAttribute("data-xi"),i=r.getAttribute("data-yi"),n=r.getAttribute("data-ai"),o=r.getAttribute("data-bi"),l=r.getAttribute("data-ci");let c,d,u,h;if(null!=s)u="X",h="X",c=d3.select(r).selectAll("text.tick-x"),d=t.state.lastXScale.domain();else if(null!=i)u="0"===i?"Y":"Y"+(+i+1),h="Y"+ +i,c=d3.select(r).selectAll("text.tick-y"),d=(t.state.multiYScales?.[i]||t.state.lastYScale).domain(),window.activeYi=+i;else if(null!=n)u="A",h="A",c=d3.select(r).selectAll("text.tick-a"),d=t.state.axisScales.a.domain();else if(null!=o)u="B",h="B",c=d3.select(r).selectAll("text.tick-b"),d=t.state.axisScales.b.domain();else{if(null==l)return;u="C",h="C",c=d3.select(r).selectAll("text.tick-c"),d=t.state.axisScales.c.domain()}window.selectedAxisName=u,c.attr("contenteditable",!0).style("outline","1px solid #4A90E2").style("cursor","pointer"),t.state.activeTicks=c;const m=t=>document.getElementById(t),p=m("axis-label"),f=m("scalemin"),y=m("scalemax"),g=m("tickcount"),x=m("scaleformat"),v=m("useCustomTicks"),w=m("customticks");p.textContent="Axis Settings: "+u,f.value=d[0].toFixed(2),y.value=d[1].toFixed(2);const k=["A","B","C"].includes(u),b=u.startsWith("Y"),T="X"===u?t.state.overrideCustomTicksX:k?t.state.overrideCustomTicksTernary?.[u.toLowerCase()]:t.state.overrideCustomTicksY?.[window.activeYi];w.value=T?.join(",")||"",g.value=("X"===u?t.state.overrideXTicks:k?t.state.overrideTernaryTicks?.[u.toLowerCase()]:t.state.overrideYTicks?.[window.activeYi])||c.size(),x.value="X"===u?t.state.overrideScaleformatX??0:u.startsWith("Y")?t.state.overrideScaleformatY?.[window.activeYi]??0:t.state.overrideScaleformatTernary?.[u.toLowerCase()]??0,document.querySelector('label[for="scaleformat"]').textContent=["Format: 00","Format: K","Format: e"][+x.value];const S="X"===u||b||k;v.disabled=!S,v.checked=!(!t.state.useCustomTicksOn||!t.state.useCustomTicksOn[h]),x.disabled=k,g.disabled=v.checked,w.disabled=!v.checked;const M=document.getElementById("showMinorTicks");M.disabled=!1,M.checked=!1!==t.state.minorTickOn[h]})},e("scalemin",!0),e("scalemax",!1),document.getElementById("tickcount").addEventListener("input",function(){const e=+this.value;if("X"===window.selectedAxisName)t.state.overrideXTicks=e;else if("Y"===window.selectedAxisName||window.selectedAxisName.startsWith("Y")){const a=window.activeYi;t.state.overrideYTicks=t.state.overrideYTicks||{},t.state.overrideYTicks[a]=e}else["A","B","C"].includes(window.selectedAxisName)&&(t.state.overrideTernaryTicks=t.state.overrideTernaryTicks||{},t.state.overrideTernaryTicks[window.selectedAxisName.toLowerCase()]=e);t.renderChart()}),document.getElementById("scaleformat").addEventListener("input",function(){const e=+this.value;if(document.querySelector('label[for="scaleformat"]').textContent=["Format: 00","Format: K","Format: e"][e],"X"===window.selectedAxisName)t.state.overrideScaleformatX=e;else if(window.selectedAxisName.startsWith("Y")){const a=window.activeYi||0;t.state.overrideScaleformatY=t.state.overrideScaleformatY||{},t.state.overrideScaleformatY[a]=e}t.renderChart()}),document.getElementById("customticks").addEventListener("input",function(){const e=this.value.trim(),a=e?e.split(",").map(t=>parseFloat(t.trim())).filter(t=>!isNaN(t)):null;if("X"===window.selectedAxisName)t.state.overrideCustomTicksX=a;else if(window.selectedAxisName.startsWith("Y")){const e=window.activeYi||0;t.state.overrideCustomTicksY=t.state.overrideCustomTicksY||{},a?t.state.overrideCustomTicksY[e]=a:delete t.state.overrideCustomTicksY[e]}else{const e=Array.from(t.state.activeTicks.nodes()[0].classList).find(t=>t.startsWith("tick-")&&!["tick-label","tick-x","tick-y"].includes(t));if(e){const r=e.split("-")[1];t.state.overrideCustomTicksTernary=t.state.overrideCustomTicksTernary||{},a?t.state.overrideCustomTicksTernary[r]=a:delete t.state.overrideCustomTicksTernary[r]}}t.renderChart()}),document.getElementById("useCustomTicks").addEventListener("change",function(){const e=this.checked,a=document.getElementById("customticks"),r=document.getElementById("tickcount");a.disabled=!e,r.disabled=e;const s="X"===window.selectedAxisName?"X":window.selectedAxisName.startsWith("Y")?"Y"+(window.activeYi||0):window.selectedAxisName;t.state.useCustomTicksOn=t.state.useCustomTicksOn||{},t.state.useCustomTicksOn[s]=e;if(e){const e=(i=a.value).trim()?i.split(",").map(t=>+t.trim()).filter(Number.isFinite):[];if("X"===s)t.state.overrideCustomTicksX=e;else if(s.startsWith("Y")){const a=window.activeYi||0;t.state.overrideCustomTicksY=t.state.overrideCustomTicksY||{},t.state.overrideCustomTicksY[a]=e}else{const a=s.toLowerCase();t.state.overrideCustomTicksTernary=t.state.overrideCustomTicksTernary||{},t.state.overrideCustomTicksTernary[a]=e}}else if("X"===s)t.state.overrideCustomTicksX=null;else if(s.startsWith("Y")){const e=window.activeYi||0;t.state.overrideCustomTicksY&&delete t.state.overrideCustomTicksY[e]}else{const e=s.toLowerCase();t.state.overrideCustomTicksTernary&&delete t.state.overrideCustomTicksTernary[e]}var i;t.renderChart()}),document.getElementById("showMinorTicks").addEventListener("change",function(){if(!window.selectedAxisName)return;let e="X"===window.selectedAxisName?"X":window.selectedAxisName.startsWith("Y")?"Y"+(window.activeYi||0):window.selectedAxisName;t.state.minorTickOn[e]=this.checked,t.renderChart()})}(window.GraphPlotter),function(t){function e(e,a,r,s,i,n){switch(e.selectAll(".legend-marker").remove(),a){case"scatter":case"ternary":{const a=t.config.SYMBOL_TYPES[i%t.config.SYMBOL_TYPES.length],o=d3.symbol().type(a).size(Math.PI*r.symbolsize**2);e.append("path").classed("legend-marker",!0).attr("d",o).attr("transform",`translate(${n/2},0)`).attr("fill",s.color);break}case"scatterline":case"ternaryline":{e.append("line").classed("legend-marker",!0).attr("x2",n).attr("stroke",s.color).attr("stroke-width",r.linewidth);const a=t.config.SYMBOL_TYPES[i%t.config.SYMBOL_TYPES.length],o=d3.symbol().type(a).size(Math.PI*r.symbolsize**2);e.append("path").classed("legend-marker",!0).attr("d",o).attr("transform",`translate(${n/2},0)`).attr("fill",s.color);break}case"bar":case"histogram":e.append("rect").classed("legend-marker",!0).attr("width",n).attr("height",8).attr("y",-4).attr("fill",s.color);break;case"area":case"ternaryarea":e.append("rect").classed("legend-marker",!0).attr("width",n).attr("height",8).attr("y",-4).attr("fill",s.color).attr("fill-opacity",r.opacity);break;default:e.append("line").classed("legend-marker",!0).attr("x2",n).attr("stroke",s.color).attr("stroke-width",r.linewidth)}}t.ui.drawLegend=function(){const a=d3.select("#chart svg"),r=t.state.hot.getData(),s=r[0],i=t.getSeries(),n=t.getSettings(),o=s.map((e,a)=>"Y-axis"===e&&t.state.colEnabled[a]?a:-1).filter(t=>t>=0),l=t.config.DIM.W-t.config.DIM.MR-100,c=t.config.DIM.MT+25,d=a.selectAll("g.legend-group").data(o,t=>t);d.exit().remove(),d.attr("transform",function(t,e){return this.dataset.savedTransform||`translate(${l},${c+20*e})`});d.enter().append("g").classed("legend-group",1).attr("data-col",t=>t).attr("transform",(t,e)=>`translate(${l},${c+20*e})`).call(t.utils.applyDrag).each(function(a,s){e(d3.select(this),n.type,n,i[s],s,20);const o=t.utils.editableText(d3.select(this),{x:25,y:-10,text:r[2][a]});o.fo.attr("width",o.div.node().scrollWidth+o.pad);const l=o.div.node();l.addEventListener("click",t=>{t.stopPropagation(),l.focus()}),l.addEventListener("keydown",t=>{"Enter"===t.key&&(t.preventDefault(),l.blur())}),l.addEventListener("blur",function(){t.state.hot.setDataAtCell(2,a,l.textContent.trim(),"paste"),t.state.hot.render(),d3.select(l).attr("contenteditable",!1).style("outline","none").style("cursor","move")})}),d.select("foreignObject div").text(t=>r[2][t]),d.each(function(t,a){d3.select(this).selectAll(".legend-marker").remove(),e(d3.select(this),n.type,n,i[a],a,20)})},t.ui.drawErrorBars=function(t,e,a,r){const s=("bar"===r.type&&a.x.bandwidth?a.x.bandwidth():0)/e.length,i="bar"===r.type?.2*s:r.symbolsize;e.forEach((e,n)=>{e.error&&e.rawX.forEach((o,l)=>{const c=e.error[l];if(!isFinite(c))return;const d="bar"===r.type?a.x(o)+n*s+s/2:a.x(o),u=a.y(e.y[l]+c),h=a.y(e.y[l]-c);t.append("line").attr("x1",d).attr("x2",d).attr("y1",u).attr("y2",h).attr("stroke",e.errorColor).attr("stroke-width",r.linewidth),[u,h].forEach(a=>t.append("line").attr("x1",d-i).attr("x2",d+i).attr("y1",a).attr("y2",a).attr("stroke",e.errorColor).attr("stroke-width",r.linewidth))})})}}(window.GraphPlotter),function(t){t.ui.toolTip=function(e,a){const r=d3.select("#tooltip");e.on("mousemove",function(s){const[i,n]=d3.pointer(s,e.node());if(i<t.config.DIM.ML||i>t.config.DIM.W-t.config.DIM.MR||n<t.config.DIM.MT||n>t.config.DIM.H-t.config.DIM.MB)return;const o=a.xScale.invert(i).toFixed(4),l=a.yScale.invert(n).toFixed(4);r.html("X-Scale:<b> "+o+"</b><br>Y-Scale:<b> "+l+"</b>")})},t.ui.areacalculation=function(){const e=d3.select("#chart svg");if(e.empty())return;const a=d3.brushX().extent([[t.config.DIM.ML,t.config.DIM.MT],[t.config.DIM.W-t.config.DIM.MR,t.config.DIM.H-t.config.DIM.MB]]).on("end",function({selection:a}){if(e.selectAll(".area-highlight").remove(),!a)return void d3.select("#areaResults").html("");const[r,s]=a,i=t.state.lastXScale.invert(r),n=t.state.lastXScale.invert(s),o=Math.min(i,n),l=Math.max(i,n),c=document.querySelector('input[name="axistitles"]:checked').value,d="ftir"===c?100:t.state.lastYScale.domain()[0]<=0&&0<=t.state.lastYScale.domain()[1]?0:t.state.lastYScale.domain()[0],u=t.state.lastYScale(d);let h="";t.getSeries().forEach(a=>{const r=a.x.map((t,e)=>({x:t,y:a.y[e]})).filter(t=>t.x>=o&&t.x<=l);if(r.length<2)return;let s=0;for(let t=0;t<r.length-1;t++){s+=(r[t+1].x-r[t].x)*("ftir"===c?d-(r[t].y+r[t+1].y)/2:(r[t].y+r[t+1].y)/2)}e.append("path").datum(r).attr("class","area-highlight").attr("d",d3.area().x(e=>t.state.lastXScale(e.x)).y0(()=>u).y1(e=>t.state.lastYScale(e.y))).attr("fill",a.color).attr("fill-opacity","ftir"===c?.1:.2).lower(),h+=`<div style="color:${a.color};">${a.label}: Area = <b>${s.toFixed(4)}</b></div>`}),d3.select("#areaResults").html(h||"<em>No data in selected range.</em>")}),r=e.append("g").attr("class","area-brush").style("display","none").call(a);d3.select("#enableAreaCalc").on("change",function(){this.checked?r.style("display",null):(r.style("display","none").call(a.move,null),e.selectAll(".area-highlight").remove(),d3.select("#areaResults").html(""))})},t.ui.disableAreaCal=function(){const t=document.getElementById("enableAreaCalc");t.checked&&(t.checked=!1,t.dispatchEvent(new Event("change")))}}(window.GraphPlotter),function(t){function e(e,a){if(t.state.activeTicks){var r="color"==e?"fill":"fontSize"==e?"font-size":"fontFamily"==e?"font-family":"fontWeight"==e?"font-weight":"fontStyle"==e?"font-style":e,s=(t.state.activeTicks.attr("class")||"").split(/\s+/).find(t=>t.startsWith("tick-")&&"tick-label"!==t);if(s){var i=s.slice(5),n="y"==i&&window.activeYi||0;t.state.tickLabelStyles[i]=t.state.tickLabelStyles[i]||{},t.state.tickLabelStyles[i][n]=t.state.tickLabelStyles[i][n]||{},t.state.tickLabelStyles[i][n][e]=a,t.state.activeTicks.style(r,a)}}}function a(){if(void 0!==t.state.activeText&&t.state.activeText)return t.state.activeText.node?t.state.activeText.node():t.state.activeText;if(void 0!==t.state.activeDiv&&t.state.activeDiv)return t.state.activeDiv.node?t.state.activeDiv.node():t.state.activeDiv;const e=window.getSelection&&window.getSelection();if(!e||0===e.rangeCount)return null;let a=e.anchorNode instanceof Element?e.anchorNode:e.anchorNode&&e.anchorNode.parentElement;if(!a)return null;return a.closest&&a.closest("foreignObject > div[contenteditable]")||null}function r(){const t=a(),e=!!t&&document.queryCommandState("superscript"),r=!!t&&document.queryCommandState("subscript"),s=document.getElementById("supBtn"),i=document.getElementById("subBtn");e?(s.classList.add("active"),i.classList.remove("active")):r?(i.classList.add("active"),s.classList.remove("active")):(s.classList.remove("active"),i.classList.remove("active"))}t.ui.refs.colorCtrl=d3.select("#addedtextcolor"),t.ui.refs.sizeCtrl=d3.select("#addedtextsize"),t.ui.refs.addTextBtn=d3.select("#addtext"),t.ui.refs.rmBtn=d3.select("#removebtn"),t.ui.refs.fontCtrl=d3.select("#fontfamily"),t.ui.refs.boldBtn=d3.select("#boldBtn"),t.ui.refs.italicBtn=d3.select("#italicBtn"),t.ui.refs.colorCtrl.on("input",function(){const a=this.value,r=t.state.activeText||t.state.activeDiv;if(r&&r.style("color",a),t.state.activeTicks&&e("color",a),t.state.activeGroup){const e=t.state.activeGroup.select(".shape"),r=e.node().tagName.toLowerCase();"rect"!==r&&"ellipse"!==r||"none"===e.attr("fill")?e.attr("stroke",a):e.attr("fill",a).attr("stroke",a),t.features.updateArrowMarkerColor(e,a)}}),t.ui.refs.sizeCtrl.on("input",a=>{const r=a.target.value+"px";if(e("fontSize",r),t.state.activeText||t.state.activeDiv){const e=t.state.activeText||t.state.activeDiv;e.style("font-size",r),t.state.activeFo&&t.state.activeFo.attr("width",e.node().scrollWidth+5)}if(!t.state.activeGroup)return;const s=+a.target.value,i=5+s/2,n=t.state.activeGroup.select(".shape"),o=t.state.activeGroup.select(".outline"),l=t.state.activeGroup.select(".hit");if(n.attr("stroke-width",s),l.attr("stroke-width","rect"==n.node().tagName?2*i:s+2*i),"rect"==n.node().tagName){const e=t.features.bufferOutline(n,i);o.attr("x",e.x).attr("y",e.y).attr("width",e.w).attr("height",e.h)}else{const e=t.features.bufferOutline(n,i);o.attr("points",e.join(" "))}}),t.ui.refs.fontCtrl.on("change",a=>{const r=a.target.value;e("fontFamily",r);const s=t.state.activeText||t.state.activeDiv||t.state.activeTicks;if(s&&s.style("font-family",r),t.state.activeFo){const e=t.state.activeFo,a=e.select("div").node();e.attr("width",a.scrollWidth+5)}}),t.ui.refs.boldBtn.on("click",()=>{const a=!t.ui.refs.boldBtn.classed("active");t.ui.refs.boldBtn.classed("active",a),e("fontWeight",a?"bold":"normal");const r=t.state.activeText||t.state.activeDiv||t.state.activeTicks;r&&r.style("font-weight",a?"bold":"normal")}),t.ui.refs.italicBtn.on("click",()=>{const a=!t.ui.refs.italicBtn.classed("active");t.ui.refs.italicBtn.classed("active",a),e("fontStyle",a?"italic":"normal");const r=t.state.activeText||t.state.activeDiv||t.state.activeTicks;r&&r.style("font-style",a?"italic":"normal")}),t.ui.applySupSub=function(t){const e=a();if(!e)return;e.focus();const s=document.queryCommandState("superscript"),i=document.queryCommandState("subscript");"sup"===t?(s||i&&document.execCommand("subscript",!1,null),document.execCommand("superscript",!1,null)):(i||s&&document.execCommand("superscript",!1,null),document.execCommand("subscript",!1,null)),function(t){const e=t&&t.parentNode;e&&e.tagName&&"foreignobject"===e.tagName.toLowerCase()&&(e.setAttribute("width",t.scrollWidth+5),e.setAttribute("height",t.scrollHeight+5))}(e),r()},document.getElementById("supBtn").addEventListener("mousedown",e=>{e.preventDefault(),t.ui.applySupSub("sup")}),document.getElementById("subBtn").addEventListener("mousedown",e=>{e.preventDefault(),t.ui.applySupSub("sub")}),document.addEventListener("selectionchange",r),document.addEventListener("mouseup",r),document.addEventListener("keyup",r),t.ui.refs.rmBtn.on("click",()=>{if(t.state.activeGroup)t.state.activeGroup.style("display","none"),t.state.activeGroup=null;else if(t.state.activeFo){const e=t.state.activeFo.node().parentNode;e.classList.contains("legend-group")?d3.select(e).style("display","none"):d3.select(t.state.activeFo.node()).style("display","none")}t.state.activeFo=t.state.activeDiv=null,t.ui.refs.rmBtn.classed("disabled",!0)})}(window.GraphPlotter),function(t){function e(e){e.select(".hit").style("cursor","move").on("click",a=>{t.state.hot.deselectCell(),a.stopPropagation(),t.features.activateShape(d3.select(e.node()))}),e.call(t.utils.applyDrag)}t.features.activateShape=function(e){if(t.state.activeGroup===e)return;e.select(".outline").attr("visibility","visible"),t.state.activeGroup=e;e.select(".shape");t.utils.updateInspector(e.select(".shape"))},t.features.activateText=function(e,a){if(t.state.activeText===e)return;e.attr("contenteditable",!0).style("border","1px solid rgb(74,144,226)").node().focus(),t.state.activeText=e,t.state.activeFo=a,t.utils.updateInspector(e);const r=e.node();setTimeout(()=>{const t=document.createRange();t.selectNodeContents(r);const e=window.getSelection();e.removeAllRanges(),e.addRange(t)},0)},t.features.updateArrowMarkerColor=function(t,e){let a=t.attr("marker-end");if(a&&a.startsWith("url(#arrowhead-")){let t=a.slice(5,-1);d3.select(`#${t} path`).attr("fill",e)}},t.features.bufferOutline=function(t,e){const a=t.node().tagName;if("rect"===a){return{x:+t.attr("x")-e,y:+t.attr("y")-e,w:+t.attr("width")+2*e,h:+t.attr("height")+2*e}}if("ellipse"===a){return{cx:+t.attr("cx"),cy:+t.attr("cy"),rx:+t.attr("rx")+e,ry:+t.attr("ry")+e}}{const a=+t.attr("x1"),r=+t.attr("y1"),s=+t.attr("x2"),i=+t.attr("y2"),n=s-a,o=i-r,l=Math.hypot(n,o),c=-o/l,d=n/l;return[[a+c*e,r+d*e],[s+c*e,i+d*e],[s-c*e,i-d*e],[a-c*e,r-d*e]]}},t.features.prepareShapeLayer=function(){const a=d3.select("#chart svg");a.on("click.shapeBackground",e=>{e.target===a.node()&&t.utils.clearActive()}),a.on("mousedown.draw",function(e){if("none"===t.state.shapeMode)return;e.preventDefault(),t.state.drawing=!0;const[r,s]=d3.pointer(e,a.node()),i="fillRect"===t.state.shapeMode||"fillEllipse"===t.state.shapeMode?"#96d35f":"#000000",n=t.state.shapeMode,o=/rect/i.test(n),l=/line|arrow/i.test(n),c=/arrow/i.test(n),d=/dashed/i.test(n),u="fillRect"===n||"fillEllipse"===n,h=/ellipse/i.test(n);l?(t.state.tempShape=a.append("line").attr("x1",r).attr("y1",s).attr("x2",r).attr("y2",s).attr("stroke",i).attr("stroke-width",1).attr("fill","none"),c&&t.state.tempShape.attr("marker-end",`url(#${function(e,a){let r="arrowhead-"+ ++t.state.arrowCount,s=e.select("defs");return s.empty()&&(s=e.append("defs")),s.append("marker").attr("id",r).attr("viewBox","0 -5 10 10").attr("refX",1).attr("refY",0).attr("markerWidth",6).attr("markerHeight",6).attr("orient","auto").append("path").attr("d","M0,-5L10,0L0,5").attr("fill",a),r}(a,i)})`),d&&t.state.tempShape.attr("stroke-dasharray","7,5")):o?(t.state.tempShape=a.append("rect").attr("x",r).attr("y",s).attr("width",0).attr("height",0),u?t.state.tempShape.attr("stroke",i).attr("stroke-width",.5).attr("fill",i).attr("fill-opacity",.2):(t.state.tempShape.attr("stroke",i).attr("stroke-width",1).attr("fill","none"),d&&t.state.tempShape.attr("stroke-dasharray","7,5"))):h&&(t.state.tempShape=a.append("ellipse").attr("cx",r).attr("cy",s).attr("rx",0).attr("ry",0),u?t.state.tempShape.attr("stroke",i).attr("stroke-width",.5).attr("fill",i).attr("fill-opacity",.2):(t.state.tempShape.attr("stroke",i).attr("stroke-width",1).attr("fill","none"),d&&t.state.tempShape.attr("stroke-dasharray","7,5"))),t.state.drawStart={x:r,y:s}}),a.on("mousemove.draw",function(e){if(!t.state.drawing||!t.state.tempShape)return;const[r,s]=d3.pointer(e,a.node()),i=t.state.tempShape.node().tagName;if("rect"===i){const e=t.state.drawStart.x,a=t.state.drawStart.y,i=r-e,n=s-a;t.state.tempShape.attr("x",i<0?r:e).attr("y",n<0?s:a).attr("width",Math.abs(i)).attr("height",Math.abs(n))}else if("ellipse"===i){const e=r-t.state.drawStart.x,a=s-t.state.drawStart.y,i=Math.abs(e)/2,n=Math.abs(a)/2,o=t.state.drawStart.x+(e<0?-i:i),l=t.state.drawStart.y+(a<0?-n:n);t.state.tempShape.attr("cx",o).attr("cy",l).attr("rx",i).attr("ry",n)}else t.state.tempShape.attr("x2",r).attr("y2",s)}),a.on("mouseup.draw mouseleave.draw",function(){if(!t.state.drawing||!t.state.tempShape)return;t.state.drawing=!1;const r=t.state.tempShape.node().tagName,s=t.state.tempShape.attr("stroke"),i=+t.state.tempShape.attr("stroke-width")||1,n=t.state.tempShape.node().getBBox();if(n.width<5&&n.height<5||"line"===r&&Math.hypot(n.width,n.height)<5)t.state.tempShape.remove(),t.state.tempShape=null;else{t.state.tempShape.remove();const n=a.append("g").classed("shape-group",!0),o=5;if("line"===r){const e={x1:+t.state.tempShape.attr("x1"),y1:+t.state.tempShape.attr("y1"),x2:+t.state.tempShape.attr("x2"),y2:+t.state.tempShape.attr("y2")};n.append("line").classed("hit",1).attr("x1",e.x1).attr("y1",e.y1).attr("x2",e.x2).attr("y2",e.y2).attr("stroke","transparent").attr("stroke-width",i+2*o).attr("fill","none");let a=n.append("line").classed("shape",1).attr("x1",e.x1).attr("y1",e.y1).attr("x2",e.x2).attr("y2",e.y2).attr("stroke",s).attr("stroke-width",i).attr("fill","none").attr("pointer-events","none");t.state.tempShape.attr("marker-end")&&a.attr("marker-end",t.state.tempShape.attr("marker-end")),t.state.tempShape.attr("stroke-dasharray")&&a.attr("stroke-dasharray",t.state.tempShape.attr("stroke-dasharray"));const r=t.features.bufferOutline(a,o+i/2);n.append("polygon").classed("outline",1).attr("points",r.join(" ")).attr("stroke","rgb(74,144,226)").attr("stroke-width",1).attr("fill","none").attr("pointer-events","none").attr("visibility","hidden")}else if("rect"===r){const e={x:+t.state.tempShape.attr("x"),y:+t.state.tempShape.attr("y"),width:+t.state.tempShape.attr("width"),height:+t.state.tempShape.attr("height")};let a;n.append("rect").classed("hit",1).attr("x",e.x).attr("y",e.y).attr("width",e.width).attr("height",e.height).attr("stroke","transparent").attr("stroke-width","fillRect"===t.state.shapeMode?2*o:i+2*o).attr("fill","none"),"fillRect"===t.state.shapeMode?a=n.append("rect").classed("shape",1).attr("x",e.x).attr("y",e.y).attr("width",e.width).attr("height",e.height).attr("stroke",s).attr("stroke-width",.5).attr("fill",s).attr("fill-opacity",.2):(a=n.append("rect").classed("shape",1).attr("x",e.x).attr("y",e.y).attr("width",e.width).attr("height",e.height).attr("stroke",s).attr("stroke-width",i).attr("fill","none"),t.state.tempShape.attr("stroke-dasharray")&&a.attr("stroke-dasharray",t.state.tempShape.attr("stroke-dasharray")));const r=t.features.bufferOutline(a,o);n.append("rect").classed("outline",1).attr("x",r.x).attr("y",r.y).attr("width",r.w).attr("height",r.h).attr("stroke","rgb(74,144,226)").attr("stroke-width",1).attr("fill","none").attr("pointer-events","none").attr("visibility","hidden")}else if("ellipse"===r){const e=+t.state.tempShape.attr("cx"),a=+t.state.tempShape.attr("cy"),r=+t.state.tempShape.attr("rx"),l=+t.state.tempShape.attr("ry");let c;n.append("ellipse").classed("hit",1).attr("cx",e).attr("cy",a).attr("rx",r).attr("ry",l).attr("stroke","transparent").attr("stroke-width","fillEllipse"===t.state.shapeMode?2*o:i+2*o).attr("fill","none"),"fillEllipse"===t.state.shapeMode?c=n.append("ellipse").classed("shape",1).attr("cx",e).attr("cy",a).attr("rx",r).attr("ry",l).attr("stroke",s).attr("stroke-width",.5).attr("fill",s).attr("fill-opacity",.2):(c=n.append("ellipse").classed("shape",1).attr("cx",e).attr("cy",a).attr("rx",r).attr("ry",l).attr("stroke",s).attr("stroke-width",i).attr("fill","none"),t.state.tempShape.attr("stroke-dasharray")&&c.attr("stroke-dasharray",t.state.tempShape.attr("stroke-dasharray"))),n.append("ellipse").classed("outline",1).attr("cx",e).attr("cy",a).attr("rx",r+o).attr("ry",l+o).attr("stroke","rgb(74,144,226)").attr("stroke-width",1).attr("fill","none").attr("pointer-events","none").attr("visibility","hidden")}e(n),setTimeout(()=>t.features.activateShape(n),0),t.state.tempShape=null}d3.selectAll('input[name="shape"]').property("checked",!1),t.state.shapeMode="none"})},t.ui.refs.addTextBtn.on("click",function(){t.ui.disableAreaCal();const e=d3.select("#chart svg");if(e.empty())return;const{fo:a,div:r}=t.utils.editableText(e,{x:t.config.DIM.W/2-t.config.DIM.MT,y:t.config.DIM.H/2-t.config.DIM.MR,text:"Text",rotation:0});a.classed("user-text",1).call(t.utils.applyDrag),t.utils.clearActive(),t.features.activateText(r,a)}),d3.selectAll('input[name="shape"]').on("change",function(){t.ui.disableAreaCal(),t.state.shapeMode=this.value,t.utils.clearActive()}),t.features.makeShapeInteractive=e}(window.GraphPlotter),function(t){const e=t.DIM;t.bindZoom=function(){$("#zoomBtn").click(function(){const a=$(this);if(a.hasClass("active"))return d3.select(".zoom-brush").remove(),void a.removeClass("active");a.addClass("active");const r=document.getElementById("enableAreaCalc");r.checked&&(r.checked=!1,r.dispatchEvent(new Event("change")));const s=d3.select("#chart svg");s.empty()||s.append("g").attr("class","zoom-brush").style("cursor","crosshair").call(d3.brush().extent([[e.ML,e.MT],[e.W-e.MR,e.H-e.MB]]).on("end",({selection:e})=>{if(s.select(".zoom-brush").remove(),a.removeClass("active"),!e)return;const[[r,i],[n,o]]=e,l=window.lastXScale.invert(r),c=window.lastXScale.invert(n),d=window.lastXScale.domain(),u=d[0]>d[1]?[Math.max(l,c),Math.min(l,c)]:[Math.min(l,c),Math.max(l,c)],h=[window.lastYScale.invert(i),window.lastYScale.invert(o)].sort((t,e)=>t-e);window.overrideX=u,window.overrideMultiY=window.overrideMultiY||{},window.overrideMultiY[0]=h,document.getElementById("scalemin").value=u[0].toFixed(2),document.getElementById("scalemax").value=u[1].toFixed(2),t.renderChart()}))}),d3.select("#chart").on("dblclick",()=>{t.resetScales(!0),t.renderChart()})}}(window.GraphPlotter),function(t){const e=t.COLORS;t.movingAverage=function(t,e){const a=Math.floor(e/2),r=[];for(let e=0;e<t.length;e++){let s=0,i=0;for(let r=e-a;r<=e+a;r++)r>=0&&r<t.length&&isFinite(t[r])&&(s+=t[r],i++);r[e]=i?s/i:NaN}return r},t.rollingBaseline=function(t,e){const a=Math.floor(e/2),r=[],s=[];for(let e=0;e<t.length;e++){let s=1/0;for(let r=e-a;r<=e+a;r++)r>=0&&r<t.length&&isFinite(t[r])&&(s=Math.min(s,t[r]));r[e]=s===1/0?NaN:s}for(let t=0;t<r.length;t++){let e=-1/0;for(let s=t-a;s<=t+a;s++)s>=0&&s<r.length&&isFinite(r[s])&&(e=Math.max(e,r[s]));s[t]=e===-1/0?NaN:e}return s},t.processData=function(a,r,s){const i=t.hot.getData(),n=i[0],o=i.slice(3),l=i[2].slice();n.forEach((c,d)=>{if("Y-axis"===c&&t.colEnabled[d]){if("corrected"===a&&l[d].includes("(baseline)"))return;const t=o.map(t=>parseFloat(t[d])||NaN),c=r(t,s),u=i[1].length;n.push("Y-axis"),i[1].push(e[u%e.length]),i[2].push(`${l[d]} (${a})`),o.forEach((t,e)=>t.push(c[e]))}}),t.hot.loadData(i),t.resetScales(!0),t.renderChart()},t.previewSeries=function(e,a,r){const s=d3.select("#chart svg");if(s.selectAll(`g.${r}`).remove(),a<=0)return;const i=t.getSettings(),n="ftir"===i.mode&&"baseline-preview"===r,o=t.getSeries().map(r=>{let s;if(n){const e=r.y.map(t=>-t);s=t.rollingBaseline(e,a).map(t=>-t)}else s=e(r.y,a);return{rawX:r.rawX,x:r.x,y:s,color:r.color}}),l=t.ChartRegistry.get(i.type),c=s.append("g").classed(r,!0).attr("clip-path","url(#clip)");l.draw(c,o,{x:window.lastXScale,y:window.lastYScale},i),c.selectAll("path").attr("stroke","gray").attr("stroke-width",i.linewidth)},t.bindSmoothingControls=function(){["smoothing","baseline"].forEach(e=>document.getElementById(e+"slider").addEventListener("input",a=>{"smoothing"===e&&t.renderChart(),t.previewSeries("smoothing"===e?t.movingAverage:t.rollingBaseline,+a.target.value,`${e}-preview`)})),document.getElementById("applysmoothing").onclick=()=>{const e=+document.getElementById("smoothingslider").value;e>0&&(t.processData("smoothed",t.movingAverage,e),document.getElementById("smoothingslider").value=0)},document.getElementById("applybaseline").onclick=()=>{const e=+document.getElementById("baselineslider").value;if(e<=0)return;"ftir"===t.getSettings().mode?(t.processData("baseline",(e,a)=>{const r=e.map(t=>-t);return t.rollingBaseline(r,a).map(t=>-t)},e),t.processData("corrected",(e,a)=>{const r=e.map(t=>-t),s=t.rollingBaseline(r,a).map(t=>-t);return e.map((t,e)=>isFinite(t)&&isFinite(s[e])?t/s[e]*100:NaN)},e)):(t.processData("baseline",t.rollingBaseline,e),t.processData("corrected",(e,a)=>{const r=t.rollingBaseline(e,a);return e.map((t,e)=>isFinite(t)&&isFinite(r[e])?t-r[e]:NaN)},e)),document.getElementById("baselineslider").value=0}}}(window.GraphPlotter),function(t){const e=t.COLORS,a=t.DIM;function r(t,e){const a=[],r=[];for(let s=0;s<t.length;s++){const i=+t[s],n=+e[s];Number.isFinite(i)&&Number.isFinite(n)&&(a.push(i),r.push(n))}const s=a.length;if(s<2)return null;let i=0,n=0,o=0,l=0,c=0;for(let t=0;t<s;t++){const e=a[t],s=r[t];i+=e,n+=s,o+=e*e,l+=e*s,c+=s*s}const d=s*o-i*i;if(0===d)return null;const u=(s*l-i*n)/d,h=(n-u*i)/s,m=n/s;let p=0,f=0;for(let t=0;t<s;t++){const e=r[t],s=u*a[t]+h;p+=(e-m)*(e-m),f+=(e-s)*(e-s)}return{m:u,b:h,r2:p>0?1-f/p:1}}function s(t,e){let a=0,r=0,s=0,i=0,n=0,o=0,l=0,c=0,d=0;for(let u=0;u<t.length;u++){const h=+t[u],m=+e[u];if(Number.isFinite(h)&&Number.isFinite(m)){const t=h*h,e=t*h;a+=1,r+=h,s+=t,i+=e,n+=e*h,o+=m,l+=h*m,c+=t*m,d++}}if(d<3)return null;const u=function(t,e){let a=t.map(t=>t.slice()),r=e.slice();for(let t=0;t<3;t++){let e=t;for(let r=t+1;r<3;r++)Math.abs(a[r][t])>Math.abs(a[e][t])&&(e=r);[a[t],a[e]]=[a[e],a[t]],[r[t],r[e]]=[r[e],r[t]];const s=a[t][t];if(0===s)return null;for(let e=t;e<3;e++)a[t][e]/=s;r[t]/=s;for(let e=0;e<3;e++)if(e!==t){const s=a[e][t];for(let r=t;r<3;r++)a[e][r]-=s*a[t][r];r[e]-=s*r[t]}}return r}([[n,i,s],[i,s,r],[s,r,a]],[c,l,o]);if(!u)return null;const[h,m,p]=u;let f=o/a,y=0,g=0;for(let a=0;a<t.length;a++){const r=+t[a],s=+e[a];if(Number.isFinite(r)&&Number.isFinite(s)){const t=h*r*r+m*r+p;y+=(s-f)*(s-f),g+=(s-t)*(s-t)}}return{a:h,b:m,c:p,r2:y>0?1-g/y:1}}t.bindFittingControls=function(){document.getElementById("applyfit").onclick=function(){const i=d3.select(this);if(i.classed("active"))return d3.select(".fit-brush").remove(),void i.classed("active",!1).style("background",null);const n=t.hot.getData(),o=n[0],l=n[1],c=n[2],d=n.slice(3),u=[];for(let e=0;e<o.length;e++)"Y-axis"===o[e]&&t.colEnabled[e]&&u.push(e);if(!u.length)return void alert("No enabled Y series.");const h=o.map((e,a)=>"X-axis"===e&&t.colEnabled[a]?a:-1).filter(t=>t>=0);if(!h.length)return void alert("Missing X-axis.");i.classed("active",!0).style("background","#c6c6c6");const m=d3.select("#chart svg");m.empty()||m.append("g").attr("class","fit-brush").style("cursor","crosshair").call(d3.brushX().extent([[a.ML,a.MT],[a.W-a.MR,a.H-a.MB]]).on("end",({selection:n})=>{if(m.select(".fit-brush").remove(),i.classed("active",!1).style("background",null),!n)return;const[p,f]=n.map(window.lastXScale.invert),y=Math.min(p,f),g=Math.max(p,f),x=(document.querySelector('input[name="fit"]:checked')||{value:"linear"}).value,v=[];for(const t of u){let a=-1;for(let e=0;e<h.length;e++){const r=h[e],s=h[e+1]??o.length;if(t>r&&t<s){a=r;break}}if(a<0)continue;const i=c[t],n=[],u=[];if(d.forEach(e=>{const r=parseFloat(e[a]),s=parseFloat(e[t]);Number.isFinite(r)&&Number.isFinite(s)&&r>=y&&r<=g&&(n.push(r),u.push(s))}),!(n.length<2))if("linear"===x){const t=r(n,u);if(!t)continue;const s=d.map(e=>{const r=parseFloat(e[a]);return Number.isFinite(r)&&r>=y&&r<=g?t.m*r+t.b:""});o.push("Y-axis"),l.push(e[l.length%e.length]),c.push(i+" (fit)"),d.forEach((t,e)=>t.push(s[e])),v.push(`${i}: m=${t.m.toFixed(6)}, b=${t.b.toFixed(6)}, R<sup>2</sup>=${t.r2.toFixed(5)}`)}else{if(n.length<3)continue;const t=s(n,u);if(!t)continue;const r=d.map(e=>{const r=parseFloat(e[a]);return Number.isFinite(r)&&r>=y&&r<=g?t.a*r*r+t.b*r+t.c:""});o.push("Y-axis"),l.push(e[l.length%e.length]),c.push(i+" (fit)"),d.forEach((t,e)=>t.push(r[e])),v.push(`${i}: a=${t.a.toExponential(3)}, b=${t.b.toExponential(3)}, c=${t.c.toExponential(3)}, R<sup>2</sup>=${t.r2.toFixed(5)}`)}}t.hot.loadData([o,l,c,...d]);for(let e=0;e<o.length;e++)void 0===t.colEnabled[e]&&(t.colEnabled[e]=!0);t.hot.render(),t.resetScales(!1),t.renderChart();const w=a.ML+6,k=a.MT+12,b=d3.select("#chart svg"),T=b.selectAll("foreignObject.user-text").size();v.forEach((e,a)=>{const r=t.editableText(b,{x:w,y:k+16*(T+a),text:e,rotation:0});r.div.html(e),r.fo.attr("width",r.div.node().scrollWidth+r.pad).attr("height",r.div.node().scrollHeight+r.pad),r.fo.classed("user-text",!0).call(t.applyDrag)})}))}}}(window.GraphPlotter),function(t){t.COLORS;t.bindTaucControls=function(){document.getElementById("generateTauc").addEventListener("click",()=>{const e=parseFloat(document.querySelector('input[name="tauc"]:checked').value),a=t.hot.getData().map(t=>t.slice()),r=a[0],s=a[1],i=a[2],n=r.length,o=r.indexOf("X-axis"),l=r.indexOf("Y-axis",o+1);if(o<0||l<0)return alert("Missing X-axis or Y-axis");a.forEach(t=>t.splice(n)),r.splice(n),s.splice(n),i.splice(n);const c=[];for(let t=3;t<a.length;t++)c[t]=1240/parseFloat(a[t][o]);r.push("X-axis"),s.push(s[o]),i.push(i[o]),r.push("Y-axis"),s.push(s[l]),i.push(i[l]+` (Tauc n=${e})`);for(let t=3;t<a.length;t++)a[t].push(c[t],Math.pow(2.303*c[t]*parseFloat(a[t][l]),e));t.hot.loadData(a),t.colEnabled={};const d=r.length;for(let e=0;e<d;e++)t.colEnabled[e]=e>=n;document.getElementById("axis-tauc").checked=!0,t.hot.render(),t.resetScales(!0),t.renderChart()})}}(window.GraphPlotter),function(t){t.parseTextFile=async function(t){return(await t.text()).split(/[\r\n]+/).filter(t=>t.trim()).map(t=>t.split(/[\t,;]+/).map(t=>{const e=parseFloat(t);return isNaN(e)?t.trim():e}))},t.parseXLSX=async function(e){"undefined"==typeof XLSX&&await t.loadScript("https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js");const a=await e.arrayBuffer(),r=XLSX.read(a,{type:"array"}),s=r.Sheets[r.SheetNames[0]];return XLSX.utils.sheet_to_json(s,{header:1,defval:""})},t.parseXRDML=async function(t){const e=await t.text(),a=(new DOMParser).parseFromString(e,"text/xml").querySelector("dataPoints"),r=a.querySelector("positions"),s=a.querySelector("intensities");if(!r||!s)return null;const i=parseFloat(r.querySelector("startPosition")?.textContent||0),n=parseFloat(r.querySelector("endPosition")?.textContent||0),o=s.textContent.trim().split(/\s+/).map(Number),l=(n-i)/(o.length-1);return o.map((t,e)=>[i+e*l,t])},t.loadScript=function(t){return new Promise((e,a)=>{const r=document.createElement("script");r.src=t,r.onload=e,r.onerror=a,document.head.appendChild(r)})}}(window.GraphPlotter),window.GraphPlotter.parseNMR=async function(t){let e=null,a=null,r=null;for(const s of t){const t=s.name.toLowerCase();"fid"===t?e=s:"acqus"===t?a=s:t.startsWith("procs")&&(r=s)}if(!e)return null;const s=await e.arrayBuffer(),i=new Int32Array(s),n=i.length/2,o=[],l=[];for(let t=0;t<n;t++)o.push(i[2*t]),l.push(i[2*t+1]);let c=5e3,d=400,u=0;if(a){const t=await a.text(),e=t.match(/##\$SW_h=\s*([\d.]+)/),r=t.match(/##\$SFO1=\s*([\d.]+)/);e&&(c=parseFloat(e[1])),r&&(d=parseFloat(r[1]))}if(r){const t=(await r.text()).match(/##\$SR=\s*([\-\d.]+)/);t&&(u=parseFloat(t[1]))}const h=u/d,m=1<<Math.ceil(Math.log2(n)),p=new Array(m).fill(0),f=new Array(m).fill(0);for(let t=0;t<n;t++)p[t]=o[t],f[t]=l[t];!function(t,e,a){const r=t.length;let s=0;for(let a=0;a<r;a++){a<s&&([t[a],t[s]]=[t[s],t[a]],[e[a],e[s]]=[e[s],e[a]]);let i=r>>1;for(;i>=1&&s>=i;)s-=i,i>>=1;s+=i}for(let s=2;s<=r;s<<=1){const i=2*Math.PI/s*(a?-1:1),n=Math.cos(i),o=Math.sin(i);for(let a=0;a<r;a+=s){let r=1,i=0;for(let l=0;l<s/2;l++){const c=r*t[a+l+s/2]-i*e[a+l+s/2],d=r*e[a+l+s/2]+i*t[a+l+s/2];t[a+l+s/2]=t[a+l]-c,e[a+l+s/2]=e[a+l]-d,t[a+l]+=c,e[a+l]+=d;const u=r*o+i*n;r=r*n-i*o,i=u}}}if(a)for(let a=0;a<r;a++)t[a]/=r,e[a]/=r}(p,f,!1);const y=p.map((t,e)=>Math.sqrt(t*t+f[e]*f[e])),g=new Array(m);for(let t=0;t<m;t++)g[t]=y[(t+m/2)%m];const x=[];for(let t=0;t<m;t++){const e=(c/2-t*c/m)/d+h;x.push([e,g[t]])}return x},function(t){const e="https://cdn.jsdelivr.net/gh/instanano/graph@latest/match";let a=null;t.MatchEngine={materials:null,threshold:50,async loadDB(t){const a=`${e}/${t}/match.json`,r=await fetch(a);return r.ok?(this.materials=await r.json(),this.materials):[]},match(t,e={}){const{tolerance:a=20,limit:r=50,mode:s}=e;if(!this.materials||!t.length)return[];const i=[];for(const e of this.materials){const r=e.peaks||e.p||[];let s=0;for(const e of t)for(const t of r){const r="number"==typeof t?t:t.pos||t[0];if(Math.abs(e-r)<=a){s++;break}}s>0&&i.push({ref:e.ref||e.n||e.name,formula:e.formula||e.f,score:s/t.length,matches:s})}return i.sort((t,e)=>e.score-t.score),i.slice(0,r)}},t.XRDMatch={binWidth:.5,precision:100,indexCache:{},async loadCompositions(){if(a)return a;const t=await fetch(`${e}/xrd/meta/compositions.json`);return a=await t.json(),a},async loadBin(t){if(this.indexCache[t])return this.indexCache[t];const a=`${e}/xrd/index/${t}.json`;try{const e=await fetch(a);if(!e.ok)return null;const r=await e.json();return this.indexCache[t]=r,r}catch(t){return null}},async search(t,e={}){const{tolerance:a=.4,elements:r=[],limit:s=50}=e;await this.loadCompositions();const i=new Set;t.forEach(t=>{const e=Math.floor(t/this.binWidth),r=Math.ceil(a/this.binWidth);for(let t=e-r;t<=e+r;t++)t>=0&&i.add(t)});const n=await Promise.all([...i].map(t=>this.loadBin(t))),o={};n.filter(Boolean).forEach(e=>{const r=e.d;e.c;for(let e=0;e<r.length;e++){const s=r[e]>>8,i=255&r[e],n=Math.floor(i/(this.binWidth*this.precision))*this.binWidth+i/this.precision;for(const e of t)if(Math.abs(e-n)<=a){o[s]=(o[s]||0)+1;break}}});const l=Object.entries(o).map(([e,a])=>({refId:+e,score:a/t.length,matches:a}));return l.sort((t,e)=>e.score-t.score),l.slice(0,s)}},t.bindMatchControls=function(){document.getElementById("matchBtn")?.addEventListener("click",async function(){const e=document.querySelector('input[name="axistitles"]:checked')?.value;if(!e)return alert("Select a chart mode first");const a=t.getSeries();if(!a.length)return alert("No data to match");const r=[];a.forEach(t=>{const e=Math.max(...t.y.filter(Number.isFinite));t.y.forEach((a,s)=>{a>.1*e&&Number.isFinite(t.x[s])&&r.push(t.x[s])})}),r.sort((t,e)=>t-e);const s=r.filter((t,e,a)=>0===e||t-a[e-1]>1);await t.MatchEngine.loadDB(e);const i=t.MatchEngine.match(s,{tolerance:"xrd"===e?.2:20}),n=document.getElementById("matchResults");i.length?n.innerHTML=i.map((t,e)=>`<div class="match-result"><b>${e+1}. ${t.ref}</b> (${t.formula||"N/A"}) - Score: ${(100*t.score).toFixed(1)}%</div>`).join(""):n.innerHTML="<p>No matches found</p>"})}}(window.GraphPlotter),function(t){t.saveProject=function(){const e=t.hot.getData(),a=d3.select("#chart svg"),r=[],s=[],i=[],n=[];a.selectAll("g.shape-group").each(function(){const t=d3.select(this);if("none"===t.style("display"))return;const e=t.select(".shape"),a=t.attr("transform")||"",s={type:e.node().tagName,transform:a,stroke:e.attr("stroke"),strokeWidth:e.attr("stroke-width"),fill:e.attr("fill"),fillOpacity:e.attr("fill-opacity"),strokeDasharray:e.attr("stroke-dasharray"),markerEnd:e.attr("marker-end")};"line"===e.node().tagName?(s.x1=e.attr("x1"),s.y1=e.attr("y1"),s.x2=e.attr("x2"),s.y2=e.attr("y2")):"rect"===e.node().tagName?(s.x=e.attr("x"),s.y=e.attr("y"),s.width=e.attr("width"),s.height=e.attr("height")):"ellipse"===e.node().tagName&&(s.cx=e.attr("cx"),s.cy=e.attr("cy"),s.rx=e.attr("rx"),s.ry=e.attr("ry")),r.push(s)}),a.selectAll("foreignObject.user-text").each(function(){const t=d3.select(this);if("none"===t.style("display"))return;const e=t.select("div");s.push({x:t.attr("x"),y:t.attr("y"),transform:t.attr("transform"),html:e.html(),style:{fontSize:e.style("font-size"),fontFamily:e.style("font-family"),fontWeight:e.style("font-weight"),fontStyle:e.style("font-style"),color:e.style("color")}})}),a.selectAll("g.legend-group").each(function(){const t=d3.select(this);"none"!==t.style("display")&&i.push({col:t.attr("data-col"),transform:t.attr("transform")||this.dataset.savedTransform})}),a.selectAll("g.axis-title").each(function(){const t=d3.select(this),e=t.select("foreignObject").select("div");n.push({class:t.attr("class"),transform:t.attr("transform"),html:e.html()})});const o=t.getSettings(),l={version:2,data:e,colEnabled:t.colEnabled,settings:o,shapes:r,texts:s,legends:i,axisTitles:n,overrides:{x:window.overrideX,multiY:window.overrideMultiY,xTicks:window.overrideXTicks,yTicks:window.overrideYTicks,customTicksX:window.overrideCustomTicksX,customTicksY:window.overrideCustomTicksY,ternary:window.overrideTernary,ternaryTicks:window.overrideTernaryTicks,customTicksTernary:window.overrideCustomTicksTernary,scaleformatX:window.overrideScaleformatX,scaleformatY:window.overrideScaleformatY,minorTickOn:window.minorTickOn,useCustomTicksOn:window.useCustomTicksOn},tickLabelStyles:t.tickLabelStyles},c=new Blob([JSON.stringify(l)],{type:"application/json"}),d=URL.createObjectURL(c),u=document.createElement("a");u.href=d,u.download="graph.instanano",u.click(),URL.revokeObjectURL(d)},t.downloadImage=function(){const t=document.querySelector("#chart svg");if(!t)return;const e=t.cloneNode(!0);e.querySelectorAll(".outline").forEach(t=>t.remove()),e.querySelectorAll(".area-brush,.fit-brush,.zoom-brush").forEach(t=>t.remove());const a=(new XMLSerializer).serializeToString(e),r=document.createElement("canvas");r.width=3*t.viewBox.baseVal.width,r.height=3*t.viewBox.baseVal.height;const s=r.getContext("2d");s.fillStyle="white",s.fillRect(0,0,r.width,r.height);const i=new Image;i.onload=()=>{s.drawImage(i,0,0,r.width,r.height);const t=r.toDataURL("image/png"),e=document.createElement("a");e.href=t,e.download="graph.png",e.click()},i.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(a)},t.loadProject=function(e){const a=new FileReader;a.onload=e=>{try{const a=JSON.parse(e.target.result);t.hot.loadData(a.data),t.colEnabled=a.colEnabled||{};const r=a.settings||{};r.mode&&(document.getElementById("axis-"+r.mode).checked=!0),r.type&&(document.getElementById(r.type).checked=!0),void 0!==r.multiyaxis&&(document.getElementById("multiyaxis").checked=1===r.multiyaxis),["linewidth","symbolsize","bins","opacity"].forEach(t=>{void 0!==r[t]&&(document.getElementById(t).value=r[t])}),a.overrides&&(window.overrideX=a.overrides.x,window.overrideMultiY=a.overrides.multiY,window.overrideXTicks=a.overrides.xTicks,window.overrideYTicks=a.overrides.yTicks,window.overrideCustomTicksX=a.overrides.customTicksX,window.overrideCustomTicksY=a.overrides.customTicksY,window.overrideTernary=a.overrides.ternary,window.overrideTernaryTicks=a.overrides.ternaryTicks,window.overrideCustomTicksTernary=a.overrides.customTicksTernary,window.overrideScaleformatX=a.overrides.scaleformatX,window.overrideScaleformatY=a.overrides.scaleformatY,window.minorTickOn=a.overrides.minorTickOn||{},window.useCustomTicksOn=a.overrides.useCustomTicksOn||{}),a.tickLabelStyles&&(t.tickLabelStyles=a.tickLabelStyles),t.hot.render(),t.renderChart(),setTimeout(()=>{const e=d3.select("#chart svg");(a.shapes||[]).forEach(a=>{const r=e.append("g").classed("shape-group",!0).attr("transform",a.transform),s=a.type.toLowerCase();if("line"===s){r.append("line").classed("hit",!0).attr("x1",a.x1).attr("y1",a.y1).attr("x2",a.x2).attr("y2",a.y2).attr("stroke","transparent").attr("stroke-width",10);const s=r.append("line").classed("shape",!0).attr("x1",a.x1).attr("y1",a.y1).attr("x2",a.x2).attr("y2",a.y2).attr("stroke",a.stroke).attr("stroke-width",a.strokeWidth);if(a.strokeDasharray&&s.attr("stroke-dasharray",a.strokeDasharray),a.markerEnd){const r=t.createArrowMarker(e,a.stroke);s.attr("marker-end",`url(#${r})`)}const i=t.bufferOutline(s,5);r.append("polygon").classed("outline",!0).attr("points",i.join(" ")).attr("stroke","rgb(74,144,226)").attr("fill","none").attr("visibility","hidden")}else if("rect"===s){r.append("rect").classed("hit",!0).attr("x",a.x).attr("y",a.y).attr("width",a.width).attr("height",a.height).attr("stroke","transparent").attr("stroke-width",10).attr("fill","none");const e=r.append("rect").classed("shape",!0).attr("x",a.x).attr("y",a.y).attr("width",a.width).attr("height",a.height).attr("stroke",a.stroke).attr("stroke-width",a.strokeWidth).attr("fill",a.fill||"none");a.fillOpacity&&e.attr("fill-opacity",a.fillOpacity),a.strokeDasharray&&e.attr("stroke-dasharray",a.strokeDasharray);const s=t.bufferOutline(e,5);r.append("rect").classed("outline",!0).attr("x",s.x).attr("y",s.y).attr("width",s.w).attr("height",s.h).attr("stroke","rgb(74,144,226)").attr("fill","none").attr("visibility","hidden")}else if("ellipse"===s){r.append("ellipse").classed("hit",!0).attr("cx",a.cx).attr("cy",a.cy).attr("rx",a.rx).attr("ry",a.ry).attr("stroke","transparent").attr("stroke-width",10).attr("fill","none");const t=r.append("ellipse").classed("shape",!0).attr("cx",a.cx).attr("cy",a.cy).attr("rx",a.rx).attr("ry",a.ry).attr("stroke",a.stroke).attr("stroke-width",a.strokeWidth).attr("fill",a.fill||"none");a.fillOpacity&&t.attr("fill-opacity",a.fillOpacity),r.append("ellipse").classed("outline",!0).attr("cx",a.cx).attr("cy",a.cy).attr("rx",+a.rx+5).attr("ry",+a.ry+5).attr("stroke","rgb(74,144,226)").attr("fill","none").attr("visibility","hidden")}t.makeShapeInteractive(r)}),(a.texts||[]).forEach(a=>{const r=t.editableText(e,{x:a.x,y:a.y,text:"",rotation:0});r.div.html(a.html),a.style&&r.div.style("font-size",a.style.fontSize).style("font-family",a.style.fontFamily).style("font-weight",a.style.fontWeight).style("font-style",a.style.fontStyle).style("color",a.style.color),r.fo.attr("width",r.div.node().scrollWidth+r.pad).attr("transform",a.transform),r.fo.classed("user-text",!0).call(t.applyDrag)}),(a.legends||[]).forEach(t=>{const a=e.select(`g.legend-group[data-col="${t.col}"]`);!a.empty()&&t.transform&&(a.attr("transform",t.transform),a.node().dataset.savedTransform=t.transform)}),(a.axisTitles||[]).forEach(t=>{const a=e.select(`g.${t.class.split(" ").join(".")}`);a.empty()||(a.attr("transform",t.transform),a.select("foreignObject div").html(t.html))})},100)}catch(t){console.error(t)}},a.readAsText(e)},t.bindExportControls=function(){document.getElementById("save").addEventListener("click",t.saveProject),document.getElementById("download").addEventListener("click",t.downloadImage)}}(window.GraphPlotter),function(t){const e=t.DIM,a=t.COLORS;t.getSeries=function(){const e=t.hot.getData(),a=e[0],r=[],s=e.slice(3);let i=-1,n=-1;for(let o=0;o<a.length;o++)if("X-axis"===a[o]&&!1!==t.colEnabled[o])i=o,n=-1;else if("Z-axis"===a[o]&&!1!==t.colEnabled[o])n=o;else if("Y-axis"===a[o]&&!1!==t.colEnabled[o]){let l=-1;for(let e=o+1;e<a.length&&"X-axis"!==a[e]&&"Y-axis"!==a[e];e++)if("Y-error"===a[e]&&!1!==t.colEnabled[e]){l=e;break}const c={rawX:[],x:[],y:[],z:n>=0?[]:void 0,color:e[1][o],label:e[2][o],error:l>=0?[]:void 0,errorColor:l>=0?e[1][l]:void 0};for(const t of s){const e=parseFloat(t[i]),a=parseFloat(t[o]);Number.isFinite(e)&&Number.isFinite(a)&&(c.rawX.push(t[i]),c.x.push(e),c.y.push(a),n>=0&&c.z.push(parseFloat(t[n])),l>=0&&c.error.push(parseFloat(t[l])))}r.push(c)}return r},t.getSettings=function(){const e=document.querySelector('input[name="aspectratio"]:checked')?.value||"4:2.85",a=t.ratioPresets[e]||t.ratioPresets["4:2.85"],r=document.querySelector('input[name="charttype"]:checked'),s={type:r?.id||"line",mode:document.querySelector('input[name="axistitles"]:checked')?.value||"default",symbolsize:+document.getElementById("symbolsize")?.value||a.symbolsize||5,xticks:a.xticks,yticks:a.yticks,scaleformat:+document.getElementById("scaleformat")?.value||0,bins:+document.getElementById("bins")?.value||10,multiygap:+document.getElementById("multiygap")?.value||a.multiygap,scalewidth:+document.getElementById("scalewidth")?.value||a.scalewidth,linewidth:+document.getElementById("linewidth")?.value||a.linewidth,multiyaxis:+document.getElementById("multiyaxis")?.value||0,opacity:+document.getElementById("opacity")?.value||.5,scaleFs:a.scaleFs,axisTitleFs:a.axisTitleFs,legendFs:a.legendFs,ratio:e};return r?.dataset&&Object.entries(r.dataset).forEach(([t,e])=>{/^-?\d+(\.\d+)?$/.test(e)?s[t]=+e:e.includes(",")?s[t]=e.split(",").map(t=>t.trim()):s[t]=e}),s},t.renderChart=function(){try{const a=d3.select("#chart svg");if(a.empty())return;const r=[],s=[],i=[],n=[];a.selectAll("g.shape-group").each(function(){r.push(this.cloneNode(!0))}),a.selectAll("foreignObject.user-text").each(function(){s.push(this.cloneNode(!0))}),a.selectAll("g.legend-group").each(function(){i.push({col:d3.select(this).attr("data-col"),transform:this.dataset.savedTransform||d3.select(this).attr("transform")})}),a.selectAll("g.axis-title").each(function(){n.push({class:d3.select(this).attr("class"),transform:d3.select(this).attr("transform"),html:d3.select(this).select("foreignObject div").html()})}),a.selectAll("g:not(.defs), path.series-path, foreignObject, line, rect:not(#chart-bg)").remove();const o=t.getSeries(),l=t.getSettings(),c=t.getTitles(l.mode),{xScale:d,yScale:u}=t.makeScales(l,o),h={x:d,y:u};t.computeMultiYScales(h,l,o),window.lastXScale=d,window.lastYScale=u,t.drawAxis(a,h,c,l,o);const m=t.ChartRegistry.get(l.type),p="clip";let f=a.select("defs");f.empty()&&(f=a.append("defs"));let y=f.select("#"+p);y.empty()&&(y=f.append("clipPath").attr("id",p),y.append("rect")),y.select("rect").attr("x",e.ML).attr("y",e.MT).attr("width",e.W-e.ML-e.MR).attr("height",e.H-e.MT-e.MB);const g=a.append("g").attr("clip-path",`url(#${p})`);m.draw(g,o,h,l),t.drawLegend(),t.tickEditing(a),t.toolTip(a,{xScale:d,yScale:u}),r.forEach(t=>a.node().appendChild(t)),s.forEach(t=>a.node().appendChild(t)),i.forEach(t=>{const e=a.select(`g.legend-group[data-col="${t.col}"]`);!e.empty()&&t.transform&&(e.attr("transform",t.transform),e.node().dataset.savedTransform=t.transform)}),n.forEach(t=>{const e=a.select(`g.${t.class.split(" ").join(".")}`);e.empty()||(e.attr("transform",t.transform),e.select("foreignObject div").html(t.html))}),a.selectAll("g.shape-group").each(function(){t.makeShapeInteractive(d3.select(this))}),a.selectAll("foreignObject.user-text").each(function(){d3.select(this).call(t.applyDrag)});const x=+document.getElementById("smoothingslider")?.value||0;x>0&&t.previewSeries(t.movingAverage,x,"smooth-preview");const v=+document.getElementById("baselineslider")?.value||0;v>0&&t.previewSeries(t.rollingBaseline,v,"baseline-preview")}catch(t){console.error("renderChart error:",t)}};const r={instanano:null,csv:"text",txt:"text",xls:"xlsx",xlsx:"xlsx",xrdml:"xrdml"},s={xrdml:"xrd",raw:"xrd",spc:"uvvis"};t.handleFileList=async function(e){try{const i=e&&e.items,n=i&&i.length?await(async()=>{const t=[],e=async(a,r="")=>{return a.isFile?await new Promise(e=>a.file(a=>{a.relativePath=r+a.name,t.push(a),e()})):await Promise.all((await(s=a.createReader(),new Promise(t=>{const e=[];!function a(){s.readEntries(r=>{r.length?(e.push(...r),a()):t(e)})}()}))).map(t=>e(t,r+a.name+"/")));var s};for(const t of i){const a=t.webkitGetAsEntry&&t.webkitGetAsEntry();a&&await e(a)}return t})():[...e?.files||e||[]];if(!n.length)return;const o=n.filter(t=>["fid","acqus","procs","proc2s"].includes(t.name.toLowerCase()));if(o.length&&await t.parseNMR(o))return;const l=n[0],c=l.name.split(".").pop().toLowerCase();if("instanano"===c){const e=await l.text();return void t.importState(JSON.parse(e))}const d=r[c];if(!d)return void alert("Unsupported file type: ."+c);if(s[c]){const t=document.querySelector(`input[name="axistitles"][value="${s[c]}"]`);t&&(t.checked=!0)}let u;if(u="xlsx"===d?await t.parseXLSX(l):"xrdml"===d?await t.parseXRDML(l):await t.parseTextFile(l),!u||!u.length)return;const h=Math.max(...u.map(t=>t.length)),m=Array(h).fill().map((t,e)=>0===e?"X-axis":"Y-axis"),p=Array(h).fill().map((t,e)=>a[e%a.length]),f=Array(h).fill("Sample");t.hot.loadData([m,p,f,...u]),t.colEnabled={},t.hot.getData()[0].forEach((e,a)=>{t.colEnabled[a]=!0}),t.hot.render();const y=t.detectModeFromData();if(y){const t=document.querySelector(`input[name="axistitles"][value="${y}"]`);t&&(t.checked=!0)}d3.select("#chart").selectAll("g.axis-title, g.legend-group, g.shape-group, defs, foreignObject.user-text").remove(),t.disableAreaCal(),t.tickLabelStyles={x:{fontSize:null,color:null},y:{fontSize:null,color:null}},t.resetScales(!0),t.renderChart(),t.checkEmptyColumns()}catch(t){console.error("handleFileList error:",t)}},t.bindFileHandlers=function(){const e=document.getElementById("fileinput"),a=document.getElementById("dropzone");e&&a&&(e.accept=Object.keys(r).map(t=>"."+t).join(","),a.addEventListener("click",()=>e.click()),["dragenter","dragover"].forEach(t=>a.addEventListener(t,t=>{t.preventDefault(),a.classList.add("hover")})),["dragleave","drop"].forEach(t=>a.addEventListener(t,t=>{t.preventDefault(),a.classList.remove("hover")})),a.addEventListener("drop",async e=>{e.preventDefault(),a.classList.remove("hover"),await t.handleFileList(e.dataTransfer)}),e.addEventListener("change",async()=>{await t.handleFileList(e),e.value=""}))},t.bindChartTypeControls=function(){const e=document.querySelectorAll("input[id]"),r=document.querySelectorAll("[data-show]");document.querySelectorAll('input[name="charttype"]').forEach(s=>s.addEventListener("change",()=>{e.forEach(t=>{const e=s.dataset[t.id]??t.dataset.defaultValue??t.defaultValue;null!=e&&""!==e&&(t.value=e,t.dispatchEvent(new Event("input")))}),r.forEach(t=>{t.style.display=t.dataset.show.split(/\s+/).includes(s.id)?"":"none"});const i=s.dataset.axis?.split(/\s*,\s*/).map(t=>t.trim());if(i){const e=t.hot.getData();for(;e[0].length<i.length;)e.forEach((t,e)=>t.push(0===e?i[t.length].replace("*",""):1===e?a[t.length%a.length]:2===e?"Sample":""));t.hot.loadData(e);let r=i.findIndex(t=>t.endsWith("*"));r<0&&(r=i.length);const s=i.map(t=>t.replace(/\*$/,"")),n=s.slice(r);t.hot.getData()[0].forEach((e,a)=>{const i=a<r?s[a]:n.length?n[(a-r)%n.length]:e;t.hot.setDataAtCell(0,a,i),t.colEnabled[a]=t.colEnabled[a]&&s.includes(i)}),t.hot.render()}t.resetScales(!1),t.renderChart(),t.checkEmptyColumns()}))},t.bindSliderControls=function(){["smoothingslider","baselineslider","multiyaxis"].forEach(t=>{const e=document.getElementById(t);function a(){e.classList.toggle("zero","0"===e.value)}e&&(e.addEventListener("input",a),a())}),document.querySelectorAll("span[data-current-value]").forEach(t=>{const e=document.getElementById(t.dataset.currentValue);e&&"range"===e.type&&(t.textContent=e.value,e.oninput=()=>{t.textContent=e.value})})},t.bindKeyboardShortcuts=function(){const e=navigator.platform.match(/Mac/)?"Meta":"Control";function a(t,e){const a=t.split("+"),r=a.pop().toLowerCase();document.addEventListener("keydown",t=>{if(document.activeElement.isContentEditable)return;const s={meta:t.metaKey,control:t.ctrlKey,shift:t.shiftKey,alt:t.altKey};a.every(t=>s[t.toLowerCase()])&&t.key.toLowerCase()===r&&(t.preventDefault(),e())})}a(`${e}+s`,()=>document.getElementById("save")?.click()),a(`${e}+d`,()=>document.getElementById("download")?.click()),a(`${e}+z`,()=>{t.resetScales(!0),t.renderChart()}),a("Escape",()=>t.clearActive()),a("Delete",()=>{(t.activeGroup||t.activeFo)&&document.getElementById("removebtn")?.click()}),a("Backspace",()=>{(t.activeGroup||t.activeFo)&&document.getElementById("removebtn")?.click()})},t.init=function(){try{const e=document.querySelector('input[name="aspectratio"]:checked')?.value||"4:2.85",[a,r]=e.split(":").map(Number),s=600,i=s*r/a;t.DIM.W=s,t.DIM.H=i;const n=d3.select("#chart").append("svg").attr("viewBox",`0 0 ${s} ${i}`).attr("preserveAspectRatio","xMidYMid meet").style("background","white");n.append("rect").attr("id","chart-bg").attr("width",s).attr("height",i).attr("fill","white"),t.initTable(),t.hot.getData()[0].forEach((e,a)=>{t.colEnabled[a]=!0}),t.bindScaleInputs(),t.bindInspectorControls(),t.bindSupSubControls(),t.bindShapeControls(),t.bindSmoothingControls(),t.bindFittingControls(),t.bindTaucControls(),t.bindZoom(),t.bindFileHandlers(),t.bindExportControls(),t.bindKeyboardShortcuts(),t.bindSliderControls(),t.prepareShapeLayer(),t.areacalculation(),document.querySelectorAll('input[name="axistitles"], #multiyaxis, #linewidth, #symbolsize, #bins, #opacity').forEach(e=>e.addEventListener("change",()=>t.renderChart())),document.querySelectorAll('input[name="charttype"]').forEach(e=>e.addEventListener("change",()=>t.renderChart())),document.querySelectorAll('input[name="aspectratio"]').forEach(e=>e.addEventListener("change",function(){const[e,a]=this.value.split(":").map(Number),r=600,s=r*a/e;t.DIM.W=r,t.DIM.H=s,d3.select("#chart svg").attr("viewBox",`0 0 600 ${s}`).select("#chart-bg").attr("width",r).attr("height",s),t.resetScales(!0),t.renderChart()})),n.on("click",e=>{e.target!==n.node()&&"chart-bg"!==e.target.id||t.clearActive()}),t.bindChartTypeControls();const o=document.querySelector('input[name="charttype"]:checked');o&&o.dispatchEvent(new Event("change"))}catch(t){console.error("init error:",t)}},document.addEventListener("DOMContentLoaded",t.init)}(window.GraphPlotter);