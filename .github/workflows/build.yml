name: Build Bundle

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install terser for minification
        run: npm install -g terser

      - name: Create dist folder
        run: mkdir -p dist

      - name: Build bundle
        run: |
          cat \
            core/config.js \
            core/utils.js \
            core/registry.js \
            table/table.js \
            charts/line.js \
            charts/scatter.js \
            charts/bar.js \
            charts/area.js \
            charts/ternary.js \
            axis/scales.js \
            axis/draw.js \
            axis/edit.js \
            ui/legend.js \
            ui/tooltip.js \
            ui/inspector.js \
            features/shapes.js \
            features/zoom.js \
            features/smoothing.js \
            features/fitting.js \
            features/tauc.js \
            features/upsell.js \
            parsers/parsers.js \
            parsers/nmr.js \
            match/core.js \
            match/standard.js \
            match/xrd.js \
            export/export.js \
            graph.core.js \
            > dist/graph.bundle.js

      - name: Minify bundle
        run: terser dist/graph.bundle.js -o dist/graph.bundle.min.js -c -m

      - name: Show bundle sizes
        run: |
          echo "ðŸ“Š Bundle sizes:"
          ls -lh dist/*.js | awk '{print $5, $9}'

      - name: Commit and push built files
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add dist/
          git diff --staged --quiet || git commit -m "ðŸ”¨ Auto-build: Update bundle files"
          git push origin HEAD:${{ github.ref }}
